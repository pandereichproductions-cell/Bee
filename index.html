<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPELLING Bee 25‚Äì26</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#eaf0ff;
      --muted:#b8c5ea;
      --good:#3ee08f;
      --bad:#ff6b6b;
      --accent:#ffd166;
      --inlineIcon:22px;
      --pillIcon:64px;
      --flyIcon:64px;
    }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 20% 10%, #1a2a55 0%, var(--bg) 55%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:min(880px, 100%);
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      position:relative;
      height: calc(100vh - 36px);      /* 18px padding arriba + 18px abajo */
      max-height: 980px;              /* tope en desktop grande */
      display: flex;
      flex-direction: column;
    }
    header{
      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(0,0,0,.10);
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:10px;
    }
    header .left{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .titles{ display:flex; flex-direction:column; gap:2px; }
    header h1{ margin:0; font-size:17px; letter-spacing:.5px; }
    header .subtitle{ font-size:12px; color:var(--muted); letter-spacing:.2px; }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      color: var(--muted);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .menuBtn{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 12px;
      font-size:16px;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    main{
      flex: 1;
      overflow: auto;
      padding: 18px;
    }

    .bigWord{
      margin:10px 0 12px;
      min-height:92px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight:900;
      letter-spacing: 7px;
      font-size: clamp(38px, 7vw, 68px);
      color: var(--accent);
      text-shadow: 0 8px 30px rgba(0,0,0,.35);
      user-select:none;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      justify-content:center;
    }
    button{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:14px 16px;
      font-size:16px;
      cursor:pointer;
      user-select:none;
      transition: transform .04s ease, background .15s ease;
      min-width: 150px;
    }
    button:active{ transform: scale(.98); }
    button.primary{
      background: rgba(255, 209, 102, .18);
      border-color: rgba(255, 209, 102, .35);
    }
    button.next{ background: rgba(255,255,255,.10); }
    button.good{
      background: rgba(62, 224, 143, .16);
      border-color: rgba(62, 224, 143, .35);
      min-width: 160px;
    }
    button.bad{
      background: rgba(255, 107, 107, .16);
      border-color: rgba(255, 107, 107, .35);
      min-width: 160px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      font-size:13px;
      color: var(--muted);
      white-space:nowrap;
    }

    /* MENU DRAWER */
    .drawerBackdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 50;
    }
    .drawer{
      position:absolute;
      top:0; right:0;
      height:100%;
      width:min(420px, 90vw);
      background: rgba(17,27,46,.98);
      border-left:1px solid rgba(255,255,255,.10);
      transform: translateX(100%);
      transition: transform .18s ease;
      padding:12px;
      box-sizing:border-box;
      overflow:auto;
    }
    .drawerBackdrop.open{ display:block; }
    .drawerBackdrop.open .drawer{ transform: translateX(0%); }
    .drawer h2{ margin:0 0 10px; font-size:16px; }
    .drawer .small{ color: var(--muted); font-size:12px; margin:0 0 8px; }
    .drawer .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .drawer .btnRow button{ min-width: 0; flex:1; padding:12px 12px; font-size:14px; }

    .tabs{ display:flex; gap:8px; margin-top:12px; }
    .tabBtn{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      font-size:13px;
    }
    .tabBtn.active{
      border-color: rgba(255, 209, 102, .35);
      background: rgba(255, 209, 102, .14);
    }
    .search{
      width:100%;
      margin-top:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    .listBox{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      max-height: 260px;  /* menos alto => menos scroll general del drawer */
      overflow:auto;
      font-size:13px;
      color: var(--muted);
      line-height:1.55;
    }
    .listItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .listItem:last-child{ border-bottom:none; }
    .tagBad{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.12);
      color: var(--text);
    }
    .tagOk{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(62,224,143,.35);
      background: rgba(62,224,143,.12);
      color: var(--text);
    }

    /* Range selector */
    .rangeCard{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .rangeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .rangeTop b{ color: var(--text); }
    .rangeRow{
      display:grid;
      grid-template-columns: 60px 1fr 60px;
      gap:10px;
      align-items:center;
      margin-top:8px;
    }
    input[type="range"]{ width:100%; accent-color: var(--accent); }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas;
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      text-align:center;
    }

    /* Practice mode toggle */
    .modeCard{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .seg{
      display:flex; gap:8px; margin-top:8px;
    }
    .seg button{
      flex:1;
      min-width:0;
      padding:10px 10px;
      font-size:13px;
      border-radius:14px;
    }
    .seg button.active{
      border-color: rgba(255, 209, 102, .35);
      background: rgba(255, 209, 102, .14);
    }

    /* User picker overlay */
    .overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 80;
      padding:18px;
    }
    .overlay.open{ display:flex; }
    .picker{
      width:min(520px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,27,46,.98);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding:16px;
    }
    .picker h2{ margin:0 0 6px; font-size:18px; }
    .picker p{ margin:0 0 12px; color: var(--muted); font-size:13px; }
    .pickerGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .userBtn{
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      text-align:center;
      transition: transform .04s ease;
    }
    .userBtn:active{ transform: scale(.98); }
    .avatar{ font-size:40px; margin-bottom:8px; }
    .initials{ font-weight:900; letter-spacing:.6px; font-size:18px; }
    .sub{ color: var(--muted); font-size:12px; margin-top:4px; }
  
    /* Card container */
    .card{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:16px;
    }

    /* Help panel */
    #helpPanel{
      position: fixed;
      left: 0; right: 0;
      bottom: 14px;
      display:flex;
      justify-content:center;
      z-index: 90;
      pointer-events:none;
    }
    .helpCard{
      pointer-events:auto;
      width:min(720px, calc(100% - 36px));
      background: rgba(17,27,46,.98);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    .helpTitle{ font-weight:900; letter-spacing:.2px; margin-bottom:8px; text-align:center; }
    .helpBtns{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:center;
    }
    .helpText{
      margin-top:10px;
      color: var(--muted);
      font-size:14px;
      line-height:1.4;
      text-align:center;
    }
	.helpBtn{
	  min-width: 48px !important;
	  width: 48px;
	  padding: 12px 0;
	  font-size: 20px;
	  border-radius: 50%;
	  background: rgba(255,255,255,.06);
	  border: 1px solid rgba(255,255,255,.12);
	}
	.helpBtn:hover{
	  background: rgba(255,255,255,.12);
	}

    /* Awards */
    .awardsRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin: 8px 0 6px;
    }
    .award{
      width: 40px;
      height: 40px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 26px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition: transform .15s ease, filter .2s ease, opacity .2s ease;
      user-select:none;
    }
    .award.locked{
      filter: grayscale(1);
      opacity: .35;
    }
    .award.unlocked{
      opacity: 1;
    }
    .award.pop{
      transform: scale(1.14);
    }

    
    .awardImg{
      width: 30px;
      height: 30px;
      object-fit: contain;
      display:block;
    }
    .mysteryIcon{
      font-size: 22px;
      line-height: 1;
    }

    /* Award zoom-to-center overlay (Diamond Bee celebration) */
    .awardZoomOverlay{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 6000;
      display: none;
    }
    .awardZoomItem{
      position: fixed;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 70px rgba(0,0,0,.58);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      transform: translate(0px,0px) scale(1);
      will-change: transform;
    }
    .awardZoomImg{
      width: 78%;
      height: 78%;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.45));
    }
    .awardZoomEmoji{
      font-size: 72px;
      line-height: 1;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.45));
    }
.confetti{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 120;
      display:none;
    }

    /* Word disintegration canvas (particles) */
    .wordFx{
      position: fixed;
      left: 0; top: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 110; /* above app, below comboBanner(10000) but that is fixed too */
      display: none;
    }

    .awardMsg{
      text-align:center;
      margin-top:6px;
      font-size:14px;
      color: var(--muted);
      min-height: 1.4em;
    }
	
	.nextBtn{
	  min-width: 48px !important;
	  width: 48px;
	  padding: 12px 0;
	  font-size: 20px;
	  border-radius: 50%;
	  background: rgba(255,255,255,.08);
	  border: 1px solid rgba(255,255,255,.12);
	}


  
.controlRow{
  display:flex;
  gap:12px;
  justify-content:center;
  align-items:center;
  width:100%;
}
.controlRowMain{ margin-bottom:10px; }
.controlRowNav{ opacity:0.95; }


.bandNumInput{
  width: 78px;
  text-align: center;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.92);
  font-weight: 800;
  padding: 8px 10px;
  outline: none;
}
.bandNumInput:focus{
  box-shadow: 0 0 0 3px rgba(255,255,255,.18);
}
.bandNumInput::-webkit-outer-spin-button,
.bandNumInput::-webkit-inner-spin-button{
  -webkit-appearance: none;
  margin: 0;
}
.bandNumInput[type=number]{ -moz-appearance: textfield; }


/* --- Practice band refinements --- */
.bandNumInput{
  width: 56px !important;
  padding: 6px 6px !important;
  font-size: 14px;
}

/* Make sliders longer and avoid overlap */
.rangeRow{
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 12px;
  align-items: center;
}

.rangeRow input[type="range"]{
  width: 100%;
  margin-left: 6px;
}


.listItem{ cursor: pointer; }
.listItem:hover{ filter: brightness(1.07); }


#statusBadge{
  display:block;
  text-align:center;
  margin: 8px 0 6px 0;
  font-weight: 700;
  opacity: .9;
}


/* Inline status between pills */
.statusInline{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 14px;
  white-space: nowrap;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.18);
  opacity: .95;
}
.rowTop{
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}


#statsPills{
  display:flex;
  justify-content:center;
  gap:14px;
  margin: 6px 0 2px 0;
}



/* TOP stats pills: always big (even after JS rebuilds) */
/* TOP stats emoji fallback size */
#statsPills .emojiIcon{
  display:flex;
  align-items:center;
  justify-content:center;
  width: var(--pillIcon);
  height: var(--pillIcon);
  font-size: calc(var(--pillIcon) - 6px);
  line-height: 1;
}
/* Tighten spacing inside the top stats pills */
#statsPills .statPill{
  gap: 4px !important;
}
#statsPills .statPill span{
  font-size: 16px;
  font-weight: 900;
  line-height: 1;
  color: var(--text);
  margin: 0;
}
/* Range pill anchored inside the game window */
main > section.card{
  position: relative;
}
#rangePill{
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 5;
}


/* success pop animation */
@keyframes pillPop{
  0%{ transform: scale(1); }
  35%{ transform: scale(1.22); }
  70%{ transform: scale(0.98); }
  100%{ transform: scale(1); }
}
.pillPop{
  animation: pillPop 260ms ease-out;
}


/* Coin fly (emoji) */
.coinFly{
  position: fixed;
  z-index: 9999;
  width: 52px;
  height: 52px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 48px;
  pointer-events: none;
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
}

/* Poop fly (from poops  button to poops  pill) */
.poopFly{
  position: fixed;
  z-index: 9999;
  width: 52px;
  height: 52px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 48px;
  pointer-events: none;
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
}


/* Stats pills: big emoji + number underneath */
.statPill .statIcon{
  font-size: 52px;
  line-height: 1;
}
.statPill .statNum{
  font-size: 14px;
  font-weight: 900;
  color: var(--text);
  line-height: 1.1;
}


/* Hide pill chrome, keep icon + number */
/* Combo banner */
#comboBanner{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translateX(-50%) scale(0.9);
  background: rgba(20,20,20,0.9);
  color: #fff;
  padding: 14px 18px;
  border-radius: 14px;
  text-align: center;
  z-index: 10000;
  pointer-events: none;
  opacity: 0;
  font-weight: 800;
}
#comboBanner.show{
  animation: comboPop 2600ms ease-out forwards;
}
#comboBanner .line1{ font-size: 22px; }
#comboBanner .line2{ font-size: 18px; margin-top: 4px; }
#comboBanner .line3{ font-size: 20px; margin-top: 6px; color: var(--accent); }

@keyframes comboPop{
  0%{ opacity:0; transform: translateX(-50%) scale(0.7); }
  15%{ opacity:1; transform: translateX(-50%) scale(1.08); }
  25%{ opacity:1; transform: translateX(-50%) scale(1); }
  85%{ opacity:1; transform: translateX(-50%) scale(1); }
  100%{ opacity:0; transform: translateX(-50%) scale(0.98); }
}




/* --- ICON SIZES (PNG / consistent on iPhone + desktop) --- */
:root{
  --inlineIcon: 22px;     /* icons inside buttons / small UI */
  --pillIcon: 64px;       /* big icons in the top stats pills */
  --flyIcon: 64px;        /* flying coin/poo visual size */
}

/* default inline icon */
.iconImg{
  width: var(--inlineIcon);
  height: var(--inlineIcon);
  vertical-align: -4px;
}

/* icons used by JS when it rebuilds the pills */
.statIconImg{
  width: var(--pillIcon);
  height: var(--pillIcon);
  display:block;
  max-width: none;
  max-height: none;
}

/* icons used by flying animations */
.flyIconImg{
  width: 100%;
  height: 100%;
  display:block;
  pointer-events:none;
}

/* force the TOP stats pill icons to stay big (even after JS rebuilds pills) */
/* Emoji fallback inside TOP stats pills: force same size as PNG */
#statsPills .emojiIcon.emoji-pill{
  width: var(--pillIcon) !important;
  height: var(--pillIcon) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-size: calc(var(--pillIcon) - 6px) !important;
  line-height: 1 !important;
}

/* Keep icon + counter tight in TOP pills (JS may rebuild markup) */
#statsPills .statPill{
  gap: 2px !important;
  padding: 4px 6px !important;
}
#statsPills .statPill span,
#statsPills .statNum{
  font-size: 16px !important;
  font-weight: 900 !important;
  line-height: 1 !important;
  margin: 0 !important;
  color: var(--text) !important;
}

/* flying containers follow --flyIcon (JS also sets explicit px sizes) */
.coinFly, .poopFly{
  width: var(--flyIcon);
  height: var(--flyIcon);
}


/* Wrong-answer effect: red glow + gentle shake on the word */
@keyframes wrongFlash{
  0%{ transform: scale(1); filter:none; }
  12%{ transform: scale(1.02); filter: drop-shadow(0 0 10px rgba(255,0,0,.55)) drop-shadow(0 0 26px rgba(255,0,0,.28)); }
  55%{ transform: scale(1.00); filter: drop-shadow(0 0 6px rgba(255,0,0,.35)); }
  100%{ transform: scale(1); filter:none; }
}
@keyframes wrongShake{
  0%{ transform: translateX(0); }
  15%{ transform: translateX(-6px); }
  30%{ transform: translateX(6px); }
  45%{ transform: translateX(-4px); }
  60%{ transform: translateX(4px); }
  100%{ transform: translateX(0); }
}
/* #wordBox already uses .bigWord */
.bigWord.wrongFX{
  color: #ff4b4b !important;
  text-shadow: 0 10px 28px rgba(255,0,0,.22) !important;
  animation: wrongFlash 520ms ease-out, wrongShake 380ms ease-out;
}

/* iOS Safari stability for emoji fallback: avoid filter-based compositing glitches */
body.emojiMode .coinFly,
body.emojiMode .poopFly{
  filter: none !important;
}
body.emojiMode .emoji-fly{
  text-shadow: 0 6px 18px rgba(0,0,0,.25);
}

/* Hide range pill completely */
#rangePill{
  display: none !important;
}

/* Shorter "I got it" / "Oops" buttons */
#markRow .good,
#markRow .bad{
  min-width: 120px;      /* antes ~160px */
  padding: 12px 14px;    /* menos ancho */
  font-size: 15px;       /* opcional */
}
/* Shorter Listen / Show buttons */
#primaryControls .primary,
#primaryControls #btnShow{
  min-width: 120px;     /* antes eran m√°s largos */
  padding: 12px 14px;
  font-size: 15px;
}

    /* ---- Consolidated (Bee46): remove duplicate overrides ---- */
    #statsPills img{
      width: var(--pillIcon) !important;
      height: var(--pillIcon) !important;
      max-width: none !important;
      max-height: none !important;
      vertical-align: -10px;
    }
    .statPill{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-width: 74px;
      background: transparent;
      box-shadow: none;
      border: none;
      padding: 4px 6px;
    }

  </style>
</head>

<body>
<div id="comboBanner"></div>

  <div class="app">
    <header>
      <div class="left">
        <div class="titles">
          <h1>SPELLING Bee 25‚Äì26</h1>
          <div class="subtitle">5th and 6th graders</div>
        </div>
        
      </div>
      <button class="menuBtn" id="menuBtn" aria-label="Menu">‚ò∞ <span id="userBadge">‚Äî</span></button>
    </header>

    <main>
      <section class="card">
        <div class="pill" id="rangePill">‚Äî</div>
        
<div id="awardsRow" class="awardsRow" aria-label="Awards"></div>
        <div id="awardMsg" class="awardMsg" aria-live="polite"></div>
        <canvas id="confetti" class="confetti" aria-hidden="true"></canvas>

<div class="row rowTop">
<div id="statsPills">
<div class="pill statPill" id="goodPill"><img src="img/coin.png" class="iconImg" alt="coin" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'ü™ô')"> <span>0</span></div>
      <div class="pill statPill" id="hardPill"><img src="img/poo.png" class="iconImg" alt="poo" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'üí©')"> <span>0</span></div>
</div>
</div>

        <canvas id="wordFx" class="wordFx" aria-hidden="true"></canvas>

        <div class="bigWord" id="wordBox">‚Ä¢ ‚Ä¢ ‚Ä¢</div>

        <div class="controls" id="primaryControls">
<div class="controlRow controlRowMain">
  <button class="primary" id="btnSpeak">üîä Listen</button>
  <button id="btnShow">üëÄ Show</button>
</div>
<div class="controlRow controlRowNav">
  <button class="next nextBtn" id="btnPrev" title="Previous word">‚¨ÖÔ∏è</button>
  <button class="next nextBtn" id="btnNext">‚û°Ô∏è</button>
  <button id="btnHelp" class="helpBtn">‚ùì</button>
</div>
</div>


        <div class="controls" id="markRow" style="display:none; margin-top:14px;">
          <button class="good" id="btnUp"><img src="img/coin.png" class="iconImg" alt="coin" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'ü™ô')"> I got it</button>
          <button class="bad" id="btnDown"><img src="img/poo.png" class="iconImg" alt="poo" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'üí©')"> Oops</button>
        </div>
      </section>
    </main>

      <div id="helpPanel" style="display:none;">
        <div class="helpCard">
          <div class="helpTitle">Help</div>
          <div class="helpBtns">
            <button id="btnDef">üìò Definition</button>
            <button id="btnEx">üó£ Example</button>
            <button id="btnHelpClose">‚úñ Close</button>
          </div>
          <div class="helpText" id="helpText"></div>
        </div>
      </div>


    <div class="drawerBackdrop" id="drawerBackdrop">
      <div class="drawer" role="dialog" aria-modal="true" aria-label="Menu">
        <h2>Menu</h2>
        <p class="small">One round = every word in the practice set exactly once (no repeats).</p>

        <div class="btnRow">
          <button id="btnSwitchUser">üë§ Switch user</button>
          <button id="btnCloseMenu">Close</button>
        </div>

        <!-- practice mode -->
        <div class="modeCard">
          <b>Practice mode</b>
          <div class="small" id="modeHint">‚Äî</div>
          <div class="seg">
            <button id="modeAll" class="active">All words</button>
            <button id="modeFailed">Failed only (<img src="img/poo.png" class="iconImg" alt="poo" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'üí©')">)</button>
          </div>
        </div>

        <!-- NEW: word order mode -->
        <div class="modeCard">
          <b>Word order</b>
          <div class="small" id="orderHint">‚Äî</div>
          <div class="seg">
            <button id="orderRandom" class="active">Random</button>
            <button id="orderInOrder">In order</button>
          </div>
        </div>

        <div class="rangeCard">
          <div class="rangeTop">
            <b>Practice band</b>
            <span class="mono" id="rangeLabel">‚Äî</span>
          </div>

          <div class="small">Choose word numbers (1 to <span id="maxN">0</span>)</div>

          <div class="rangeRow">
            <input type="number" class="mono bandNumInput" id="fromVal" value="1" inputmode="numeric" />
            <input type="range" id="fromSlider" min="1" max="1" value="1" />
            
          </div>

          <div class="rangeRow">
            <input type="number" class="mono bandNumInput" id="toVal" value="1" inputmode="numeric" />
            <input type="range" id="toSlider" min="1" max="1" value="1" />
            
          </div>

          <div class="btnRow" style="margin-top:10px;">
</div>
          <div class="btnRow" style="margin-top:10px;">
            <button id="btnResetAwards">Reset awards üîí</button>
          </div>
        </div>

        <div class="tabs">
          <button class="tabBtn active" id="tabAll">All words (band)</button>
          <button class="tabBtn" id="tabBad">Failed (<img src="img/poo.png" class="iconImg" alt="poo" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'üí©')">) (band)</button>
        </div>

        <input class="search" id="searchBox" placeholder="Search‚Ä¶" />

        <div class="listBox" id="listBox"></div>

        <p class="small" style="margin-top:12px;">
          Voice: English (UK). Progress is saved separately for each user on this device.
        </p>

        </div>

      </div>
    </div>

    <div class="overlay open" id="userOverlay">
      <div class="picker">
        <h2>Who are you?</h2>
        <p>Select your profile.</p>
        <div class="pickerGrid">
          <div class="userBtn" data-user="CHO">
            <div class="avatar">üë¶üèº</div>
            <div class="initials">CHO</div>
            <div class="sub">Boy</div>
          </div>
          <div class="userBtn" data-user="MHO">
            <div class="avatar">üëßüèª</div>
            <div class="initials">MHO</div>
            <div class="sub">Girl</div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script id="helpTSV" type="text/plain">

// --- Hoisted globals (avoid TDZ before init/click handlers) ---
var mp3Timestamps = window.mp3Timestamps || [];
var lastCombo5At = 0;
var lastCombo10At = 0;
var lastCombo20At = 0;
// --------------------------------------------------------------
Word	Definition	Sentence
 abdomen	the part of the body that contains the stomach and intestines	The doctor pressed gently on the patient's abdomen.
 aboard	on, onto, or within a vehicle	All passengers are welcome aboard the train.
 accident	reasons or causes that are not planned by anyone	She hurt her knee in a small cycling accident.
 anchor	a heavy device connected by a cable to a boat or ship that is dropped into the water to restrict motion	The captain ordered the crew to drop the anchor.
 ancient	very old; from a long time ago	We visited the ruins of an ancient Roman city.
 Antarctica	the continent surrounding the South Pole	Antarctica is covered by a very thick layer of ice.
 anxious	afraid or nervous especially about what may happen	She was anxious about speaking in front of a large audience.
 appreciate	to recognize the full value of	I truly appreciate all the help you have given me.
 approximate	close to the actual, but not precisely accurate or exact	The approximate cost of the trip is one hundred dollars.
 arrogant	having or revealing an exaggerated sense of one's own importance or abilities	His arrogant attitude made it difficult for him to make friends.
 artificial	made or produced by human beings rather than occurring naturally	The cake was decorated with bright artificial flowers.
 attempt	to make an effort to achieve or complete something difficult	The young climber made an attempt to reach the top of the hill.
 aware	having knowledge or realization of	The scientist was aware of how the tiny organism could reproduce.
 assessment	the evaluation or estimation of the nature, quality, or ability of someone or something	The students prepared for their final skills assessment.
 associate	to connect something with something else in thought	I associate that smell with my grandmother's house.
 athlete	a person who is proficient in sports and physical exercise	The athlete trained every day to prepare for the Olympics.
 atmosphere	the whole mass of air that surrounds the Earth	The planet Mars has a thin and cold atmosphere.
 authority	the power or right to give orders, make decisions, and enforce obedience	The teacher has the authority to assign homework and tests.
 awkward	causing or feeling embarrassment or inconvenience	The silence in the room was long and very awkward.
 beard	a growth of hair on the chin and lower cheeks of a man's face	My grandfather has a long white beard.
 beneficial	favorable or advantageous; resulting in good	Eating vegetables is extremely beneficial for your health.
 billboard	a large board that shows advertisements outdoors	We saw a huge billboard advertising the new movie.
 black	having the very dark color of coal or the night sky	She always wears black clothes in the winter.
 blend	to mix completely so that there are no longer separate parts	You must blend the flour and butter until smooth.
 blocks	a solid piece of hard material with flat sides	The toddlers played happily stacking wooden blocks.
 bloom	the state or time of being in blossom	The roses will bloom beautifully in the spring.
 bookstore	a store in which books are the primary items for sale	I spent an hour browsing the shelves at the bookstore.
 bracelet	an ornamental band or chain worn around the wrist	She received a silver bracelet as a birthday gift.
 breezy	fresh, windy	It was a warm and breezy day perfect for sailing.
 brick	a building or paving material made from baked clay	The house was built using red clay bricks.
 bright	producing a lot of light	The sun was so bright we needed sunglasses.
 bubble	a small amount of gas surrounded by another substance	The child laughed as the bubble floated away.
 bungalow	a low, small house with only one storey	They plan to retire and live in a cozy seaside bungalow.
 bury	to put in the ground and cover with earth	The dog tried to bury its bones in the garden.
 busy	actively at work	The students were very busy studying for their final exams.
 captain	the person in command of a ship or aircraft	The ship‚Äôs captain steered the vessel through the storm.
 carpet	a floor covering made from thick woven fabric	We bought a new blue carpet for the living room.
 cashier	a person handling payment in a store or bank	The cashier quickly scanned all the groceries.
 cell	a single unit of animal or plant life	Scientists use microscopes to study the structure of a cell.
 cereal	a grain used for food, typically eaten at breakfast	I eat a bowl of cereal with milk every morning.
 Chancellor	the chief minister of state in some governments	The Chancellor gave a speech about new educational reforms.
 Chicago	the capital city of Illinois	We plan to visit the tall buildings in the city of Chicago.
 chilly	noticeably cold	The morning air felt quite chilly so I put on a jacket.
 circuit	the complete path followed by an electric current	The electrician repaired the faulty circuit in the wall.
 circular	shaped like a circle or part of a circle	The table in the dining room is perfectly circular.
 clerk	a person employed to perform office work	The office clerk filed all the necessary documents.
 climate	the usual weather conditions in a place	The desert has a hot and dry climate year-round.
 comet	an object in space that travels around the sun	Astronomers tracked the bright comet as it passed by Earth.
 conservation	the controlled use of natural resources to preserve or protect	The park‚Äôs mission is wildlife conservation and protection.
 conquer	to overcome and take control of a place or people by force	The invading army was determined to conquer the entire territory.
 corrosion	the process of gradually destroying a material, typically metal, by chemical reaction	The old car was covered in rust from years of corrosion.
 crater	a hollow area shaped like the inside of a bowl	Astronauts landed near a large crater on the Moon.
 credibility	the quality of being convincing or believable	The witness lost credibility after changing her story several times.
 crucial	decisive or critical for success or failure	This final exam is crucial for passing the entire course.
 crowd	a large number of people gathered together	A large crowd watched the parade go by.
 curiosity	a strong desire to know or learn something	The cat‚Äôs curiosity led it to explore the inside of the box.
 custom	a traditional and widely accepted way of behaving	It is a local custom to exchange gifts on New Year‚Äôs Eve.
 decade	a period of ten years	The building was constructed over a decade ago.
 decide	to come to a resolution in the mind	We need to decide where we will go on vacation this summer.
 design	to plan and make a detailed drawing or plan	The architect will design the layout for the new museum.
 develop	to grow or cause to grow	Scientists continue to develop new technologies every year.
 dictation	writing down the words someone says	The teacher read a passage for the students‚Äô weekly dictation.
 dirty	covered or marked with an unclean substance	After playing outside, his hands were completely dirty.
 disappearing	vanishing from sight	The sun was disappearing quickly below the horizon.
 disguise	to give a different appearance to hide identity	The spy wore a clever disguise to enter the headquarters.
 ecology	the branch of biology that studies organisms and their environment	Studying ecology helps us understand how forests grow.
 elderly	old or aging	A kind neighbor often helps the elderly man with his groceries.
 electricity	a form of energy from charged particles	The storm caused the neighborhood to lose electricity.
 employer	a person or organization that employs people	Her new employer offers great benefits and flexible hours.
 end	the final part of something	We stayed until the end of the concert to hear the last song.
 evaporate	to turn from liquid into vapor	If you leave water in the sun, it will slowly evaporate.
 event	something that happens, especially something important	The wedding was the biggest social event of the year.
 expect	to regard something as likely to happen	I expect the mail will arrive this afternoon.
 expensive	costing a lot of money	That designer handbag is too expensive for my budget.
 extremely	to a very great degree	It was an extremely difficult puzzle to solve.
 fascinate	to attract strong attention or interest	The history of ancient Egypt always fascinates me.
 fertilization	the process of fertilizing plants or animals	The careful fertilization produced seeds with unique traits.
 fiction	literature describing imaginary events and people	Most of the books on this shelf are fiction novels.
 forbid	to refuse to allow something	The park regulations forbid walking on the protected grass.
 foreground	the part of a view nearest to the observer	In the painting, a large tree dominates the foreground.
 foreign	relating to a country or language other than one‚Äôs own	She is learning a new foreign language: Mandarin Chinese.
 forever	for all time; perpetually	I promise to love you forever and always.
 fragile	easily broken or damaged	Be careful with that box, it is very fragile.
 frustrate	to prevent someone from accomplishing something	The repeated technical difficulties began to frustrate the team.
 galaxy	a system of millions or billions of stars held together by gravity	Our solar system is part of the Milky Way galaxy.
 gas	an air-like substance that expands freely	Nitrogen is the most common gas in Earth‚Äôs atmosphere.
 generate	to produce or create	The windmills generate clean electricity for the town.
 geranium	a plant with showy, colorful flowers	She planted a bright red geranium in the flowerpot.
 glove	a covering for the hand	I need to wear a warm glove when I go out in the snow.
 goods	merchandise or possessions	The factory produces many useful goods for export.
 glacier	a slowly moving mass of ice	The hikers saw the massive blue glacier melting.
 grass	short green plants covering the ground	The children played soccer on the grass.
 hesitate	to pause before doing something	Do not hesitate to ask your teacher for help.
 hope	a feeling of expectation and desire	We have great hope for sunny weather.
 hostess	a woman who receives or entertains guests	The restaurant hostess greeted us warmly.
 hotel	a place that provides accommodation for travelers	We booked a room at the beachfront hotel.
 how	in what way or manner	Can you show me how to solve this problem?
 huge	extremely large	There was a huge crowd at the concert.
 idol	a person or thing greatly admired	The singer is her musical idol.
 illness	a disease or period of sickness	He missed school because of an illness.
 immense	extremely large in scale	The project required an immense amount of work.
 impressionism	a style of painting that began in France in the 1860s	Monet was a founder of Impressionism.
 incredible	impossible to believe; extraordinary	She performed an incredible gymnastics routine.
 ingredients	foods or substances used to make a dish	I bought all the ingredients for the cake.
 inhale	to breathe in	Remember to inhale deeply when you relax.
 inquiry	an act of asking for information	The teacher started an inquiry.
 insomnia	the inability to sleep	He suffers from chronic insomnia.
 integrity	honesty and strong moral principles	A leader must have integrity.
 jubilee	a special anniversary celebration	The town celebrated the Queen‚Äôs Jubilee.
 juvenile	relating to young people	The youth center offers programs for juvenile athletes.
 just	exactly; precisely	The bus arrived just on time.
 kindness	being friendly and considerate	Kindness makes the world better.
 lamps	devices that give light	We changed the lamps in the living room.
 labyrinth	a complicated maze of paths	The children got lost in the labyrinth.
 legendary	famous and well known	King Arthur is a legendary hero.
 literacy	the ability to read and write	The program improved adult literacy.
 lifeguard	a person who rescues swimmers	The lifeguard saved a child.
 majestic	having impressive beauty	The majestic castle stood on the hill.
 magma	molten rock beneath the Earth‚Äôs surface	The volcano is filled with hot magma.
 male	a person or animal that produces sperm	The peacock is a male bird.
 malice	the intention or desire to do evil; ill will	There was no malice in his joke.
 marathon	a long-distance running race	She trained for a year to run a marathon.
 marshmallow	a soft sweet made from sugar and gelatin	We ate a pink marshmallow after lunch.
 master	a person who has complete control of something	He is a master chef.
 metaphor	a figure of speech comparing two unlike things	‚ÄúTime is money‚Äù is a common metaphor.
 meridian	a circle of longitude on the Earth	Greenwich is the Prime Meridian.
 met	past tense of meet	I met my teacher yesterday.
 meteorology	the science of weather and the atmosphere	She studies meteorology.
 melancholy	a feeling of sadness	The music made me feel melancholy.
 migration	seasonal movement of animals	The migration of birds is amazing.
 mitochondria	parts of cells that produce energy	Mitochondria give cells energy.
 moisture	water in the air or on surfaces	The air was heavy with moisture.
 molars	large back teeth used for grinding	Molars help us chew food.
 monologue	a long speech by one person	The actor gave a powerful monologue.
 moss	a small green plant that grows in damp places	Moss covered the old wall.
 mosque	a Muslim place of worship	Many people visit the mosque.
 mount	to climb or go up	We will mount the hill.
 muscle	tissue that moves parts of the body	Strong muscles help you run.
 narrow	small in width	The road was narrow.
 nautical	related to the sea or ships	The room had a nautical theme.
 neurons	nerve cells that send signals	The brain uses neurons.
 nerve	a fiber that carries signals in the body	The dentist numbed my nerve.
 nickname	an informal name	His nickname is Speedy.
 night	the time of darkness	The stars shine at night.
 notorious	famous for something bad or good	The street is notorious for traffic.
 nutritious	healthy and nourishing	Spinach is nutritious.
 obsession	being overly focused on something	Stamp collecting was his obsession.
 offensive	causing anger or hurt	His words were offensive.
 operation	a surgical procedure	The patient needed an operation.
 opponent	someone you compete against	She played her opponent in chess.
 orient	to align or position	Orient the map north.
 otherwise	in a different way	Study hard, otherwise you may fail.
 outrageous	shockingly bad or excessive	The price was outrageous.
 patience	ability to wait calmly	Teaching needs patience.
 paranormal	beyond normal scientific understanding	She enjoys paranormal stories.
 passionate	having strong feelings	He is passionate about wildlife.
 paycheck	money paid for work	I got my first paycheck.
 peninsula	land almost surrounded by water	Florida is a peninsula.
 pharynx	the passage behind the nose and mouth	Food passes through the pharynx.
 philosopher	a person who studies philosophy	Socrates was a famous philosopher.
 phrase	a small group of words that form a unit	The teacher explained the phrase.
 pollen	fine yellow powder from flowers	Bees carry pollen.
 pollination	the transfer of pollen to fertilize plants	Wind helps with pollination.
 post office	a place that provides mail services	I went to the post office.
 prejudice	an unfair opinion formed without facts	Prejudice is wrong.
 preserve	to keep something in its original state	We must preserve history.
 program	a planned series of events or courses	The school started a new program.
 prokaryotic	a type of cell without a nucleus	Bacteria are prokaryotic.
 property	something that belongs to someone	They sold their property.
 pry	to ask too many personal questions	Don‚Äôt pry into her life.
 pyramid	a stone structure with sloping sides	The pyramids are in Egypt.
 quantity	the amount of something	We need a large quantity.
 raft	a flat floating structure	We crossed the river on a raft.
 ranch	a large farm	He works on a cattle ranch.
 rare	not common	That book is rare.
 read	to look at written words	I like to read before bed.
 receptor	a cell that responds to stimuli	Taste buds have receptors.
 reinforce	to make stronger	They reinforced the bridge.
 reindeer	a deer from cold regions	Santa rides with reindeer.
 relief	a feeling of calm after worry	She felt relief after the test.
 renewable resources	natural resources that can be replaced	Wind and solar are renewable resources.
 repair	to fix something	He will repair the chair.
 resort	a place for vacations	We stayed at a beach resort.
 reuse	to use again	Try to reuse plastic bags.
 ring	a circular band worn on a finger	She wore a gold ring.
 river	a large flowing body of water	The boat moved down the river.
 robbery	taking things by force	The robbery was reported.
 rush	to move in a hurry	We had to rush.
 sanctuary	a safe place	The animals live in a sanctuary.
 skeptical	having doubts	He is skeptical.
 sheet	a piece of cloth for a bed	She changed the sheet.
 shout	to speak loudly	Do not shout in the library.
 silkworms	insects that make silk	Silkworms produce silk.
 silver	a shiny white metal	Her necklace is silver.
 sled	a vehicle for snow	The children rode the sled.
 snakebite	a bite from a snake	They treated the snakebite.
 snowflake	a piece of snow	Each snowflake is unique.
 soda	a fizzy drink	I drank orange soda.
 soil	earth for plants	The garden needs soil.
 solar	related to the sun	Solar panels make energy.
 solution	a way to solve a problem	The scientists found a solution.
 somehow	in a way that is not known	We will manage somehow.
 something	an unknown thing	I heard something.
 somewhere	in an unknown place	My phone is somewhere.
 speak	to say something	He will speak tomorrow.
 speed	how fast something moves	The car has great speed.
 spiral	winding in a curve	The water went down in a spiral.
 spirit	the nonphysical part of a person	She has a kind spirit.
 spoil	to ruin something	Milk will spoil if left out.
 spectacle	something visually impressive	The sunset was a spectacle.
 squeeze	to press tightly	Squeeze the lemon.
 stage	a period in a process	The project is in an early stage.
 stare	to look fixedly	It is rude to stare.
 stem	the main stalk of a plant	The flower has a long stem.
 stereo	a sound system	He bought a new stereo.
 stimulus	something that causes a reaction	Light is a stimulus for plants.
 stove	a cooking or heating device	Turn off the stove.
 stretch out	to extend your body	Stretch out your legs.
 subject	something being studied	Math is my favorite subject.
 suggested	proposed an idea	The teacher suggested a new book.
 sunlight	light from the sun	Plants need sunlight.
 suspect	to think something is true	The police suspect theft.
 tadpole	a baby frog	We saw a tadpole.
 talkative	liking to talk a lot	She is very talkative.
 tendon	tissue connecting muscle to bone	He injured a tendon.
 thunder	a loud sound after lightning	We heard thunder.
 toboggan	a sled for snow	They rode a toboggan.
 tolerance	acceptance of differences	Tolerance is important.
 training	learning a skill	She is in training.
 turbulence	violent air movement	The plane hit turbulence.
 undertake	to take on a task	They will undertake the job.
 unpredictable	not easy to predict	The weather is unpredictable.
 unicellular	made of one cell	Amoebas are unicellular.
 virtual	existing online	We had a virtual meeting.
 vivid	very clear and strong	I had a vivid dream.
 viviparous	giving birth to live young	Humans are viviparous.
 vow	a serious promise	They made a vow.
 wagged	moved back and forth	The dog wagged its tail.
 war	armed conflict	The war ended.
 wavy	having waves	She has wavy hair.
 weapon	something used to cause harm	The guard carried a weapon.
 werewolf	a person who turns into a wolf	The movie showed a werewolf.
 which	used to choose from options	Which one do you want?
 wildlife	wild animals	The park protects wildlife.
 wind energy	energy from wind	Wind energy is clean.
 womb	where a baby grows	The baby is in the womb.
 wonderful	very good	We had a wonderful time.
 wring	to twist and squeeze	Wring the cloth.
 yearly	happening every year	It is a yearly event.
 zygote	the first cell formed from sperm and egg	A zygote begins life.
</script>


<!-- ===== Embedded timestamps CSV (for file:// testing, no CORS) ===== -->
<script id="TIMESTAMPS_CSV" type="text/plain">
Index;Word;Start;End
1; abdomen;2.13;2.92
2; aboard;4.81;5.64
3; accident;7.93;8.84
4; anchor;10.91;11.56
5; ancient;13.7;14.41
6; Antarctica;16.53;17.52
7; anxious;19.74;20.58
8; appreciate;22.98;23.98
9; approximate;26.22;27.35
10; arrogant;29.6;30.38
11; artificial;32.58;33.47
12; attempt;35.6;36.2
13; aware;38.59;39.23
14; assessment;42.27;43.07
15; associate;45.85;46.71
16; athlete;49.3;50.13
17; atmosphere;52.53;53.34
18; authority;55.41;56.18
19; awkward;58.95;59.62
20; beard;61.87;62.57
21; beneficial;65.21;66.08
22; billboard;68.8;69.62
23; black;71.95;72.71
24; blend;75.3;76.05
25; blocks;78.69;79.56
26; bloom;83.6;84.38
27; bookstore;86.84;87.7
28; bracelet;90.47;91.35
29; breezy;94.6;95.48
30; brick;97.65;98.26
31; bright;101;101.65
32; bubble;104.29;104.92
33; bungalow;107.73;108.48
34; bury;111.06;111.61
35; busy;114.66;115.31
36; captain;117.81;118.53
37; carpet;121.09;121.75
38; cashier;124.51;125.3
39; cell;127.71;128.39
40; cereal;130.54;131.3
41; Chancellor;133.69;134.52
42; Chicago;137.24;138.1
43; chilly;141;141.62
44; circuit;144.15;144.75
45; circular;147.43;148.24
46; clerk;150.95;151.46
47; climate;154.16;154.89
48; comet;157.58;158.22
49; conservation;160.99;162.04
50; conquer;164.24;165.05
51; corrosion;169.48;170.61
52; crater;173.4;174.11
53; credibility;176.98;177.86
54; crucial;180.66;181.46
55; crowd;184.54;185.29
56; curiosity;187.79;188.88
57; custom;192.45;193.17
58; decade;195.93;196.69
59; decide;199.41;200.19
60; design;202.39;203.12
61; develop;205.43;206.1
62; dictation;209.27;210.18
63; dirty;212.57;213.19
64; disappearing;215.68;216.65
65; disguise;219.51;220.39
66; ecology;223.25;224.1
67; elderly;226.73;227.42
68; electricity;230.22;231.12
69; employer;234.06;234.96
70; end;237.2;237.66
71; evaporate;240.47;241.32
72; event;244.32;244.96
73; expect;247.78;248.81
74; expensive;251.63;252.84
75; extremely;255.42;256.83
76; fascinate;260.08;260.95
77; fertilization;263.48;264.61
78; fiction;267.43;268.2
79; forbid;270.67;271.29
80; foreground;273.41;274.35
81; foreign;276.96;277.61
82; forever;279.97;280.67
83; fragile;283.31;284.09
84; frustrate;287.02;287.82
85; galaxy;291.04;291.85
86; gas;294.28;294.89
87; generate;297.51;298.28
88; geranium;301.77;302.54
89; glove;305.45;306.22
90; goods;308.4;309.09
91; glacier;311.79;312.79
92; grass;315.19;315.93
93; hesitate;318.35;319.16
94; hope;321.62;322.17
95; hostess;324.71;325.55
96; hotel;327.93;328.67
97; how;331.02;331.6
98; huge;333.91;334.75
99; idol;337.63;338.2
100; illness;340.41;341.08
101; immense;344.8;345.47
102; impressionism;348.6;349.64
103; incredible;352.53;353.74
104; ingredients;356.82;357.79
105; inhale;360.83;361.54
106; inquiry;364.48;365.22
107; insomnia;368.47;369.42
108; integrity;372.59;373.43
109; jubilee;376.5;377.35
110; juvenile;380.58;381.46
111; just;384.74;385.19
112; kindness;388.73;389.6
113; lamps;392.95;393.65
114; labyrinth;397;397.75
115; legendary;401.16;402.07
116; literacy;405.58;406.41
117; lifeguard;409.88;410.71
118; majestic;413.7;414.56
119; magma;418.03;418.73
120; male;421.98;422.58
121; malice;425.74;426.48
122; marathon;429.78;430.56
123; marshmallow;433.84;434.8
124; master;438.07;438.8
125; metaphor;442.08;442.86
126; meridian;448.31;449.12
127; met;452.19;452.67
128; meteorology;456.12;457.21
129; melancholy;460.45;461.36
130; migration;464.37;465.27
131; mitochondria;468.44;469.54
132; moisture;472.73;473.5
133; molars;476.81;477.64
134; monologue;481.17;482.04
135; moss;485.45;486.23
136; mosque;489.34;489.97
137; mount;492.97;493.45
138; muscle;496.84;497.54
139; narrow;501.02;501.68
140; nautical;504.78;505.46
141; neurons;508.91;509.67
142; nerve;513.22;513.8
143; nickname;516.81;517.55
144; night;520.74;521.27
145; notorious;525.76;526.68
146; nutritious;529.75;530.6
147; obsession;535.02;535.89
148; offensive;539.1;539.94
149; operation;543.47;544.39
150; opponent;547.31;547.95
151; orient;552.93;553.56
152; otherwise;556.57;557.38
153; outrageous;560.39;561.36
154; patience;564.54;565.24
155; paranormal;568.55;569.42
156; passionate;572.41;573.12
157; paycheck;576.13;576.78
158; peninsula;579.91;580.63
159; pharynx;583.52;584.18
160; philosopher;587.05;587.89
161; phrase;590.89;591.57
162; pollen;594.55;595.12
163; pollination;597.98;598.9
164; post office;601.88;602.79
165; prejudice;605.87;606.64
166; preserve;609.59;610.31
167; program;613.52;614.23
168; prokaryotic;617.25;618.31
169; property;621.26;621.94
170; pry;624.86;625.43
171; pyramid;628.33;629.02
172; quantity;632.07;632.84
173; raft;635.94;636.62
174; ranch;639.62;640.25
175; rare;643.51;644.04
176; read;648.33;648.82
177; receptor;652.56;653.47
178; reinforce;656.48;657.45
179; reindeer;660.4;661.18
180; relief;663.7;664.31
181; renewable resources;667.56;669.14
182; repair;672.05;672.73
183; resort;675.53;676.21
184; reuse;679.21;680.02
185; ring;683.07;683.59
186; river;686.42;686.95
187; robbery;689.94;690.66
188; rush;693.5;694.03
189; sanctuary;696.81;697.86
190; skeptical;700.28;701.21
191; sheet;704.33;704.85
192; shout;707.77;708.41
193; silkworms;711.36;712.49
194; silver;715.27;715.99
195; sled;718.9;719.68
196; snakebite;722.51;723.46
197; snowflake;726.24;727.11
198; soda;730;730.59
199; soil;733.32;734.05
200; solar;736.2;736.82
201; solution;740.72;741.52
202; somehow;744.15;744.9
203; something;747.66;748.32
204; somewhere;750.71;751.43
205; speak;754.11;754.81
206; speed;757.51;758.17
207; spiral;761.03;761.74
208; spirit;764.48;765.15
209; spoil;767.74;768.48
210; spectacle;771.27;772.15
211; squeeze;774.8;775.58
212; stage;778.35;779.03
213; stare;781.9;782.58
214; stem;785.48;786.13
215; stereo;788.96;789.77
216; stimulus;793.21;794.09
217; stove;797.08;797.8
218; stretch out;800.61;801.42
219; subject;804.21;804.97
220; suggested;807.69;808.55
221; sunlight;811.32;812.09
222; suspect;815.22;816.04
223; tadpole;819.22;820.03
224; talkative;823.14;823.9
225; tendon;827.01;827.67
226; thunder;832.4;832.95
227; toboggan;836.16;836.98
228; tolerance;840.15;840.89
229; training;843.95;844.65
230; turbulence;847.36;848.15
231; undertake;850.99;851.79
232; unpredictable;854.92;855.94
233; unicellular;859.76;860.74
234; virtual;863.86;864.58
235; vivid;867.6;868.23
236; viviparous;871.32;872.31
237; vow;875.38;876
238; wagged;878.83;879.55
239; war;882.75;883.38
240; wavy;886.05;886.64
241; weapon;889.58;890.21
242; werewolf;893.28;894.04
243; which;897.06;897.51
244; wildlife;900.5;901.32
245; wind energy;904.47;905.41
246; womb;908.59;909.21
247; wonderful;912.27;912.96
248; wring;915.75;916.4
249; yearly;919.65;920.29
250; zygote;922.94;923.58
</script>
<!-- =============================================================== -->

<script>
/** Your exact list (kept in this exact order for band numbers) **/
const WORDS = [
  "abdomen","aboard","accident","anchor","ancient","Antarctica","anxious","appreciate","approximate","arrogant",
  "artificial","attempt","aware","assessment","associate","athlete","atmosphere","authority","awkward","beard",
  "beneficial","billboard","black","blend","blocks","bloom","bookstore","bracelet","breezy","brick",
  "bright","bubble","bungalow","bury","busy","captain","carpet","cashier","cell","cereal",
  "Chancellor","Chicago","chilly","circuit","circular","clerk","climate","comet","conservation","conquer",
  "corrosion","crater","credibility","crucial","crowd","curiosity","custom","decade","decide","design",
  "develop","dictation","dirty","disappearing","disguise","ecology","elderly","electricity","employer","end",
  "evaporate","event","expect","expensive","extremely","fascinate","fertilization","fiction","forbid","foreground",
  "foreign","forever","fragile","frustrate","galaxy","gas","generate","geranium","glove","goods",
  "glacier","grass","hesitate","hope","hostess","hotel","how","huge","idol","illness",
  "immense","impressionism","incredible","ingredients","inhale","inquiry","insomnia","integrity","jubilee","juvenile",
  "just","kindness","lamps","labyrinth","legendary","literacy","lifeguard","majestic","magma","male",
  "malice","marathon","marshmallow","master","metaphor","meridian","met","meteorology","melancholy","migration",
  "mitochondria","moisture","molars","monologue","moss","mosque","mount","muscle","narrow","nautical",
  "neurons","nerve","nickname","night","notorious","nutritious","obsession","offensive","operation","opponent",
  "orient","otherwise","outrageous","patience","paranormal","passionate","paycheck","peninsula","pharynx","philosopher",
  "phrase","pollen","pollination","post office","prejudice","preserve","program","prokaryotic","property","pry",
  "pyramid","quantity","raft","ranch","rare","read","receptor","reinforce","reindeer","relief",
  "renewable resources","repair","resort","reuse","ring","river","robbery","rush","sanctuary","skeptical",
  "sheet","shout","silkworms","silver","sled","snakebite","snowflake","soda","soil","solar",
  "solution","somehow","something","somewhere","speak","speed","spiral","spirit","spoil","spectacle",
  "squeeze","stage","stare","stem","stereo","stimulus","stove","stretch out","subject","suggested",
  "sunlight","suspect","tadpole","talkative","tendon","thunder","toboggan","tolerance","training","turbulence",
  "undertake","unpredictable","unicellular","virtual","vivid","viviparous","vow","wagged","war","wavy",
  "weapon","werewolf","which","wildlife","wind energy","womb","wonderful","wring","yearly","zygote"
];
// --- Consistent icons (PNG) with fallback to native emoji ---
const ICON_COIN_SRC = "img/coin.png";
const ICON_POO_SRC  = "img/poo.png";

let ICON_MODE = "png"; // "png" | "emoji"
let _iconDetectPromise = null;

// Detect once whether PNG icons are available. If not, switch to emoji mode (no <img> -> no iOS flicker).
function detectIconMode(){
  if (_iconDetectPromise) return _iconDetectPromise;
  _iconDetectPromise = new Promise((resolve)=>{
    let done = 0, ok = 0;
    const finish = ()=>{
      if (++done < 2) return;
      ICON_MODE = (ok === 2) ? "png" : "emoji";
      document.body && document.body.classList.toggle("emojiMode", ICON_MODE === "emoji");
      resolve(ICON_MODE);
    };
    const test = (src)=>{
      const im = new Image();
      im.onload = ()=>{ ok++; finish(); };
      im.onerror = ()=>{ finish(); };
      // cache-bust a bit to avoid stale failed cache in iOS file://
      im.src = src + ((src.includes("?") ? "&" : "?") + "v=" + Date.now());
    };
    test(ICON_COIN_SRC);
    test(ICON_POO_SRC);
  });
  return _iconDetectPromise;
}

// Returns an <img> tag that falls back to emoji if the image fails to load.
function iconCoinHTML(cls="iconImg"){
  // In emoji mode, never create <img> tags (avoids iOS Safari flicker/glitches when audio plays).
  if (ICON_MODE === "emoji"){
    const kind = (cls === "flyIconImg") ? "fly" : (cls === "statIconImg" ? "pill" : "inline");
    return `<span class="emojiIcon emoji-${kind}" aria-hidden="true">ü™ô</span>`;
  }
  return `<img src="${ICON_COIN_SRC}" class="${cls}" alt="coin" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'ü™ô')">`;
}
function iconPooHTML(cls="iconImg"){
  if (ICON_MODE === "emoji"){
    const kind = (cls === "flyIconImg") ? "fly" : (cls === "statIconImg" ? "pill" : "inline");
    return `<span class="emojiIcon emoji-${kind}" aria-hidden="true">üí©</span>`;
  }
  return `<img src="${ICON_POO_SRC}" class="${cls}" alt="poo" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'üí©')">`;
}


// --- PNG icon fallback (avoids broken-image glyph; keeps sizes consistent) ---
function iconFallback(img, emoji){
  try{ img.style.opacity = 0; }catch(e){}
  const span = document.createElement('span');
  let kind = 'inline';
  if (img && img.closest && img.closest('#statsPills')) kind = 'pill';
  else if (img && (img.classList.contains('flyIconImg') || img.closest('.coinFly,.poopFly'))) kind = 'fly';
  span.className = `emojiIcon emoji-${kind}`;
  span.textContent = emoji;
  span.setAttribute('aria-hidden','true');
  img.replaceWith(span);
}
(function initIconImgs(){
  window.addEventListener('DOMContentLoaded', async ()=>{
    try{ await detectIconMode(); }catch(e){}
    document.querySelectorAll('img.iconImg, img.statIconImg, img.flyIconImg').forEach(img=>{
      // If already loaded from cache, mark as loaded (avoid staying invisible)
      if (img.complete && img.naturalWidth > 0){
        img.classList.add('loaded');
        img.style.opacity = 1;
      }
    });
  });
})();


// Help dictionary: word -> {def, ex}
const HELP = Object.create(null);

function parseHelpTSV(){
  const el = document.getElementById("helpTSV");
  if(!el) return;
  const raw = (el.textContent || "").trim();
  if(!raw) return;

  const lines = raw.split(/\r?\n/).filter(Boolean);
  if(lines.length <= 1) return;

  for(let i=1;i<lines.length;i++){
    const parts = lines[i].split("\t");
    if(parts.length < 3) continue;
    const word = (parts[0] || "").trim();
    const def  = (parts[1] || "").trim();
    const ex   = (parts.slice(2).join("\t") || "").trim();
    if(!word) continue;
    HELP[word] = { def, ex };
  }
}

const VOICE_LANG = "en-GB";
let preferredVoice = null;

let voicesActivated = false;

function silentActivation(){
  if(voicesActivated) return;
  voicesActivated = true;

  // Unlock speech synthesis on iOS
  try{
    const silent = new SpeechSynthesisUtterance(" ");
    silent.volume = 0;
    silent.lang = VOICE_LANG;
    window.speechSynthesis.speak(silent);
  }catch(e){}

  // Unlock WebAudio on iOS (first coin sound should work on first tap)
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(AudioCtx){
      if(!coinCtx) coinCtx = new AudioCtx();
      if(coinCtx.state === "suspended"){
        coinCtx.resume().catch(()=>{});
      }
      // Tiny silent blip to fully unlock output on some iOS versions
      const o = coinCtx.createOscillator();
      const g = coinCtx.createGain();
      g.gain.value = 0.00001;
      o.connect(g); g.connect(coinCtx.destination);
      o.start();
      o.stop(coinCtx.currentTime + 0.02);
    }
  }catch(e){}
}


function pickBestUKVoice(){
  const voices = window.speechSynthesis.getVoices();
  if(!voices || !voices.length) return null;

  // 1) solo voces en-GB
  // const uk = voices.filter(v => (v.lang || "").toLowerCase() === "en-gb");
  // Cambio sugerido en el paso 1
	const uk = voices.filter(v => (v.lang || "").replace('_', '-').toLowerCase() === "en-gb");

  if(!uk.length) return null;

  // 2) preferir voces buenas (Siri/premium) si existen
  const preferredNameParts = [
	"Serena",
	"Kate",
    "Siri",
    "Daniel",
    "Oliver"
  ];

  for(const part of preferredNameParts){
    const v = uk.find(v => (v.name || "").includes(part));
    if(v) return v;
  }

  // 3) fallback: primera UK
  return uk[0];
}

function ensureVoiceLoaded(){
  // iOS carga las voces tarde; esto lo ‚Äúdespierta‚Äù
  preferredVoice = pickBestUKVoice();
  if(!preferredVoice){
    // fuerza a que iOS/Safari intente cargar la lista
    window.speechSynthesis.getVoices();
  }
}

// iOS: se dispara cuando ya est√°n disponibles
window.speechSynthesis.onvoiceschanged = () => {
  preferredVoice = pickBestUKVoice();
};

// llama una vez al arrancar (por si ya est√°n cargadas)
ensureVoiceLoaded();




// ===== Awards / Rewards (per user) =====
function keyStats(user){ return `spbee_${user}_stats`; }

function loadStats(user){
  try{
    const raw = localStorage.getItem(keyStats(user));
    if(!raw) return { correct:0, wrong:0, streak:0, unlocked:{} };
    const s = JSON.parse(raw);
    return {
      correct: s.correct || 0,
      wrong: s.wrong || 0,
      streak: s.streak || 0,
      unlocked: s.unlocked || {}
    };
  }catch{
    return { correct:0, wrong:0, streak:0, unlocked:{} };
  }
}

function saveStats(user, stats){
  try{ localStorage.setItem(keyStats(user), JSON.stringify(stats)); }catch{}
}

let stats = { correct:0, wrong:0, streak:0, unlocked:{} };

const AWARDS = [
  { id:"bronze",  need: 20,   icon:"ü•â", label:"Bronze Medal" },
  { id:"silver",  need: 50,   icon:"ü•à", label:"Silver Medal" },
  { id:"gold",    need: 150,  icon:"ü•á", label:"Gold Medal" },
  { id:"trophy",  need: 350,  icon:"üèÜ", label:"Trophy" },
  { id:"crown",   need: 1000, icon:"üëë", label:"Golden Crown" },

  // NEW: Mystery final award (PNG revealed after unlock)
  {
    id:"diamond",
    need: 3000,
    label:"Diamond Bee",
    lockedHTML: '<span class="mysteryIcon" aria-label="Mystery award">‚ùì</span>',
    unlockedHTML: '<img class="awardImg" src="img/Bee_Diamond.png" alt="Diamond Bee" onerror="this.outerHTML=\'üêù\';" />'
  }
];

const awardsRow = document.getElementById("awardsRow");

function renderAwards(){
  if(!awardsRow) return;
  awardsRow.innerHTML = AWARDS.map(a => {
    const ok = !!stats.unlocked[a.id];
    const cls = ok ? "award unlocked" : "award locked";
    const title = ok ? a.label : "Mystery Award";
    const iconHTML = ok
      ? (a.unlockedHTML || a.icon || "‚≠ê")
      : (a.lockedHTML || a.icon || "‚ùì");
    return `<div class="${cls}" data-award="${a.id}" title="${title}">${iconHTML}</div>`;
  }).join("");
}

let awardMsgTimer = null;
function showAwardMessage(text){
  const el = document.getElementById("awardMsg");
  if(!el) return;
  el.textContent = text;
  if(awardMsgTimer) clearTimeout(awardMsgTimer);
  awardMsgTimer = setTimeout(()=>{ el.textContent = ""; }, 4000);
}

// Tap an award to see progress / unlock message
awardsRow && awardsRow.addEventListener("click", (e)=>{
  const el = e.target.closest(".award");
  if(!el) return;
  const id = el.getAttribute("data-award");
  const award = AWARDS.find(a => a.id === id);
  if(!award) return;

  const coins = stats.correct || 0;
  const unlocked = !!stats.unlocked[id];

  let message = "";
  if(unlocked){
    if(id === "diamond"){
      message = `You got the Diamond Bee!`;
    }else{
      message = `${award.label} unlocked! You achieved ${award.need} coins. Great job!`;
    }
  }else{
    if(id === "diamond"){
      message = `Mystery Award: You need ${award.need} coins to unlock it. You currently have ${coins}.`;
    }else{
      message = `You need ${award.need} coins to unlock this reward. You currently have ${coins}.`;
    }
  }

  showAwardMessage(message);
  speakText(message);
});

function popAward(id){
  const el = document.querySelector(`.award[data-award="${id}"]`);
  if(!el) return;
  el.classList.add("pop");
  setTimeout(()=> el.classList.remove("pop"), 260);
}


function zoomAwardToCenter(id, holdMs=5000){
  const src = document.querySelector(`.award[data-award="${id}"]`);
  if(!src) return;

  let overlay = document.getElementById("awardZoomOverlay");
  if(!overlay){
    overlay = document.createElement("div");
    overlay.id = "awardZoomOverlay";
    overlay.className = "awardZoomOverlay";
    document.body.appendChild(overlay);
  }
  overlay.innerHTML = "";
  overlay.style.display = "block";

  const rect = src.getBoundingClientRect();

  const item = document.createElement("div");
  item.className = "awardZoomItem";
  item.style.left = Math.round(rect.left) + "px";
  item.style.top  = Math.round(rect.top)  + "px";

  
  item.style.width = rect.width + "px";
  item.style.height = rect.height + "px";

  const img = src.querySelector("img");
  if(img){
	  const ci = img.cloneNode(true);
	  ci.className = "awardZoomImg";

	  // Fallback del zoom si la imagen falla
	  ci.onerror = () => {
		const span = document.createElement("span");
		span.className = "awardZoomEmoji";
		span.textContent = "üêù";
		ci.replaceWith(span);
	  };

	  // Mejora nitidez en Safari
	  ci.style.transform = "translateZ(0)";
	  ci.style.backfaceVisibility = "hidden";

	  item.appendChild(ci);

	}else{
	  const span = document.createElement("span");
	  span.className = "awardZoomEmoji";
	  span.textContent = (src.textContent || "üêù").trim() || "üêù";
	  item.appendChild(span);
	}


  overlay.appendChild(item);

  // fuerza layout
  item.getBoundingClientRect();

  const inMs = 450;
  const outMs = 450;

  const targetSize = Math.min(window.innerWidth, window.innerHeight) * 0.38;
  const w = Math.max(rect.width, targetSize);
  const h = Math.max(rect.height, targetSize);

  const leftTarget = Math.round((window.innerWidth  - w) / 2);
const topTarget  = Math.round((window.innerHeight - h) / 2);


  // Animar por geometr√≠a (no por transform scale) => m√°s n√≠tido
  item.style.transition = `left ${inMs}ms cubic-bezier(.2,.9,.2,1),
                           top ${inMs}ms cubic-bezier(.2,.9,.2,1),
                           width ${inMs}ms cubic-bezier(.2,.9,.2,1),
                           height ${inMs}ms cubic-bezier(.2,.9,.2,1)`;

  item.style.left = leftTarget + "px";
  item.style.top = topTarget + "px";
  item.style.width = w + "px";
  item.style.height = h + "px";

  setTimeout(() => {
    item.style.transition = `left ${outMs}ms cubic-bezier(.4,0,.2,1),
                             top ${outMs}ms cubic-bezier(.4,0,.2,1),
                             width ${outMs}ms cubic-bezier(.4,0,.2,1),
                             height ${outMs}ms cubic-bezier(.4,0,.2,1)`;

   item.style.left = Math.round(rect.left) + "px";
	item.style.top  = Math.round(rect.top)  + "px";

    item.style.width = rect.width + "px";
    item.style.height = rect.height + "px";
  }, inMs + holdMs);

  setTimeout(() => {
    overlay.style.display = "none";
    overlay.innerHTML = "";
  }, inMs + holdMs + outMs + 80);
}

function checkAwardsAndCelebrate(){
  let unlockedAny = false;
  let lastUnlocked = null;

  for(const a of AWARDS){
    if(stats.correct >= a.need && !stats.unlocked[a.id]){
      stats.unlocked[a.id] = true;
      unlockedAny = true;
      lastUnlocked = a.id;
    }
  }

  if(unlockedAny){
    saveStats(currentUser, stats);
    renderAwards();
    if(lastUnlocked) popAward(lastUnlocked);

	if(lastUnlocked === "diamond"){
	  launchFireworks();
	  playRewardCelebration();

	  const msg = "Congratulations! You have achieved the Diamond Bee ‚Äî the highest award possible!";
	  showAwardMessage(msg);
	  speakText(msg);

	  requestAnimationFrame(() => zoomAwardToCenter("diamond", 5000)); // üëà CLAVE
	}else{
	  launchConfetti();
	  playRewardCelebration();
	}

  }
}


// Confetti (simple canvas burst)
const confettiCanvas = document.getElementById("confetti");
let confettiRaf = null;

function launchConfetti(){
  if(!confettiCanvas) return;
  const ctx = confettiCanvas.getContext("2d");
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
  confettiCanvas.style.display = "block";

  const colors = ["#ffd166","#3ee08f","#ff6b6b","#7aa7ff","#ffffff"];
  const N = 180;
  const parts = Array.from({length:N}, () => ({
    x: Math.random() * confettiCanvas.width,
    y: -20 - Math.random() * 200,
    vx: (Math.random() - 0.5) * 7,
    vy: 2 + Math.random() * 6,
    r: 3 + Math.random() * 5,
    a: Math.random() * Math.PI,
    va: (Math.random() - 0.5) * 0.25,
    c: colors[(Math.random() * colors.length) | 0]
  }));

  const start = performance.now();

  function frame(t){
    const dt = t - start;
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    for(const p of parts){
      p.x += p.vx;
      p.y += p.vy;
      p.a += p.va;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.a);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    }

    if(dt < 3000){
      confettiRaf = requestAnimationFrame(frame);
    }else{
      confettiCanvas.style.display = "none";
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      if(confettiRaf) cancelAnimationFrame(confettiRaf);
      confettiRaf = null;
    }
  }

  if(confettiRaf) cancelAnimationFrame(confettiRaf);
  confettiRaf = requestAnimationFrame(frame);
}

// Fireworks for the final award (uses the same canvas as confetti)
function launchFireworks(){
  if(!confettiCanvas) return;
  const ctx = confettiCanvas.getContext("2d");
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
  confettiCanvas.style.display = "block";

  const W = confettiCanvas.width, H = confettiCanvas.height;
  const palette = ["#ffffff","#ffd166","#ff6b6b","#7aa7ff","#3ee08f","#ff9f1c","#b388ff"];
  const particles = [];
  const bursts = 36;              // number of fireworks
  const particlesPerBurst = 56;   // density
  const gravity = 0.06;

  function burst(){
    const x0 = Math.random()*W*0.9 + W*0.05;
    const y0 = Math.random()*H*0.45 + H*0.08;
    const base = palette[(Math.random()*palette.length)|0];

    for(let i=0;i<particlesPerBurst;i++){
      const ang = (Math.PI*2) * (i/particlesPerBurst) + (Math.random()-0.5)*0.25;
      const sp = 2.2 + Math.random()*3.2;
      particles.push({
        x:x0, y:y0,
        vx: Math.cos(ang)*sp,
        vy: Math.sin(ang)*sp,
        life: 90 + (Math.random()*55)|0,
        r: 2 + Math.random()*2.2,
        c: (Math.random()<0.35 ? "#ffffff" : base)
      });
    }
  }

  for(let i=0;i<bursts;i++){
    setTimeout(burst, i*140);
  }

  let raf = null;
  let frames = 0;

  function frame(){
    frames++;
    ctx.clearRect(0,0,W,H);

    // slight fade for trails
    ctx.fillStyle = "rgba(0,0,0,0.18)";
    ctx.fillRect(0,0,W,H);

    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.vy += gravity;
      p.x += p.vx;
      p.y += p.vy;
      p.life--;

      const alpha = Math.max(0, Math.min(1, p.life/70));
      ctx.globalAlpha = alpha;
      ctx.fillStyle = p.c;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();

      if(p.life<=0 || p.x<-50 || p.x>W+50 || p.y<-50 || p.y>H+80){
        particles.splice(i,1);
      }
    }
    ctx.globalAlpha = 1;

    if(frames < 720 || particles.length){
      raf = requestAnimationFrame(frame);
    }else{
      confettiCanvas.style.display = "none";
      ctx.clearRect(0,0,W,H);
      if(raf) cancelAnimationFrame(raf);
    }
  }

  // clear once before drawing trails
  ctx.clearRect(0,0,W,H);
  raf = requestAnimationFrame(frame);
}


window.addEventListener("resize", () => {
  if(confettiCanvas && confettiCanvas.style.display !== "none"){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
});
const FAILED_BONUS_WEIGHT = 4;

const USERS = {
  CHO: { label: "CHO", emoji: "üë¶üèº" },
  MHO: { label: "MHO", emoji: "üëßüèª" }
};

// practice mode (per user)
const PRACTICE_MODES = { ALL: "all", FAILED: "failed" };
let practiceMode = PRACTICE_MODES.ALL;

// NEW: word order mode (per user)
const ORDER_MODES = { RANDOM: "random", ORDER: "order" };
let orderMode = ORDER_MODES.RANDOM;

let currentUser = null;
let hardSet = new Set();
let band = { from: 1, to: 1 };
let currentIndex = null;
let navBack = [];     // stack of previously visited indices
let navForward = [];  // stack for forward navigation after going back

let revealed = false;

// deck: no repeats until all words in practice set are shown once
let deck = [];

const elUserBadge = document.getElementById("userBadge");
const elRangePill = document.getElementById("rangePill");
const elHardPill = document.getElementById("hardPill");

const elGoodPill = document.getElementById("goodPill");
const elWordBox = document.getElementById("wordBox");

const elPrimaryControls = document.getElementById("primaryControls");
const elMarkRow = document.getElementById("markRow");

const backdrop = document.getElementById("drawerBackdrop");
const elListBox = document.getElementById("listBox");


/* Tap a list item to hear pronunciation (All/Failed in band) */
elListBox.addEventListener("click", (e) => {
  const item = e.target.closest(".listItem");
  if(!item) return;
  const enc = item.getAttribute("data-w");
  if(!enc) return;
  const w = decodeURIComponent(enc);
  // MP3 timestamps primary, TTS fallback
  speakWordPrimary(w);
});

const elSearch = document.getElementById("searchBox");
const tabAll = document.getElementById("tabAll");
const tabBad = document.getElementById("tabBad");
let activeTab = "all";

const userOverlay = document.getElementById("userOverlay");

const fromSlider = document.getElementById("fromSlider");
const toSlider   = document.getElementById("toSlider");
const fromVal = document.getElementById("fromVal");
const toVal = document.getElementById("toVal");
const rangeLabel = document.getElementById("rangeLabel");
const maxN = document.getElementById("maxN");

// practice mode buttons
const btnModeAll = document.getElementById("modeAll");
const btnModeFailed = document.getElementById("modeFailed");
const modeHint = document.getElementById("modeHint");

// NEW: order mode buttons
const btnOrderRandom = document.getElementById("orderRandom");
const btnOrderInOrder = document.getElementById("orderInOrder");
const orderHint = document.getElementById("orderHint");

// Help panel elements
const helpPanel = document.getElementById("helpPanel");
const helpText = document.getElementById("helpText");
const btnDef = document.getElementById("btnDef");
const btnEx  = document.getElementById("btnEx");
const btnHelpClose = document.getElementById("btnHelpClose");

/** Buttons **/
document.getElementById("btnSpeak").addEventListener("click", () => { silentActivation(); speakCurrent(); });
document.getElementById("btnHelp").addEventListener("click", () => { silentActivation(); openHelp(); });
document.getElementById("btnShow").addEventListener("click", () => { silentActivation(); revealWordLetterByLetter(); });
document.getElementById("btnPrev").addEventListener("click", () => { silentActivation(); goPrev(true); });
document.getElementById("btnNext").addEventListener("click", () => { silentActivation(); pickNewWord(true); });

document.getElementById("btnUp").addEventListener("click", () => { silentActivation(); markWord(true); });
document.getElementById("btnDown").addEventListener("click", () => { silentActivation(); markWord(false); });
btnHelpClose.addEventListener("click", closeHelpPanel);
btnDef.addEventListener("click", () => { silentActivation(); speakHelp("def"); });
btnEx.addEventListener("click", () => { silentActivation(); speakHelp("ex"); });

document.getElementById("menuBtn").addEventListener("click", openMenu);
document.getElementById("btnCloseMenu").addEventListener("click", closeMenu);
document.getElementById("btnSwitchUser").addEventListener("click", () => { closeMenu(); openUserPicker(true); });
backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeMenu(); });

tabAll.addEventListener("click", ()=>{ activeTab="all"; tabAll.classList.add("active"); tabBad.classList.remove("active"); renderList(); });
tabBad.addEventListener("click", ()=>{ activeTab="bad"; tabBad.classList.add("active"); tabAll.classList.remove("active"); renderList(); });
elSearch.addEventListener("input", renderList);
document.getElementById("btnResetAwards").addEventListener("click", adminAwardsWithPassword);

fromSlider.addEventListener("input", syncBandUIFromSliders);
toSlider.addEventListener("input", syncBandUIFromSliders);

// Auto-apply band when the user finishes moving a slider
fromSlider.addEventListener("change", applyBandFromSliders);
toSlider.addEventListener("change", applyBandFromSliders);
document.querySelectorAll(".userBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const u = btn.getAttribute("data-user");
    selectUser(u);
  });
});

// practice mode handlers
btnModeAll.addEventListener("click", ()=> setPracticeMode(PRACTICE_MODES.ALL));
btnModeFailed.addEventListener("click", ()=> setPracticeMode(PRACTICE_MODES.FAILED));

// NEW: order mode handlers
btnOrderRandom.addEventListener("click", ()=> setOrderMode(ORDER_MODES.RANDOM));
btnOrderInOrder.addEventListener("click", ()=> setOrderMode(ORDER_MODES.ORDER));

/** Init **/
window.addEventListener('DOMContentLoaded', ()=>{ try{ init(); }catch(e){ console.error(e); } });

function init(){
  parseHelpTSV();
  maxN.textContent = String(WORDS.length);
  fromSlider.max = String(Math.max(1, WORDS.length));
  toSlider.max = String(Math.max(1, WORDS.length));

  // MP3 timestamps (embedded CSV) + automatic MP3 warmup on first user interaction
  mp3Timestamps = mp3LoadEmbeddedTimestamps();
  // First interaction triggers iOS unlock + preload (no menus / manual load)
  window.addEventListener("pointerdown", mp3Kickoff, { once:true, passive:true });
  window.addEventListener("keydown", mp3Kickoff, { once:true });

  // Always ask user every open
  openUserPicker(false);
}

function openUserPicker(){
  userOverlay.classList.add("open");
  setStatus("Choose user");
}
function closeUserPicker(){ userOverlay.classList.remove("open"); }

function selectUser(userKey){
  if(!USERS[userKey]) return;
  currentUser = userKey;

  

  // üîä Welcome intro (must be triggered by the user click/tap for iOS)
  playWelcomeIntro();
hardSet = new Set(loadHardWords(userKey));
  band = loadBand(userKey);
  practiceMode = loadPracticeMode(userKey);
  orderMode = loadOrderMode(userKey);

  stats = loadStats(userKey);
  
  // Reset streak for this session
  stats.streak = 0;
  lastCombo5At = 0;
  lastCombo10At = 0;
  lastCombo20At = 0;
  lastCombo40At = 0;
  saveStats(currentUser, stats);
renderAwards();

  band.from = clampInt(band.from, 1, Math.max(1, WORDS.length));
  band.to   = clampInt(band.to, band.from, Math.max(1, WORDS.length));

  elUserBadge.textContent = `${USERS[userKey].emoji} ${USERS[userKey].label}`;

  setSlidersFromBand();
  syncModeUI();
  syncOrderUI();


  updatePills();
  closeUserPicker();

  revealed = false;
  elMarkRow.style.display = "none";
  elPrimaryControls.style.display = "flex";
  elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
  setStatus("Ready");

  rebuildDeck();
  pickNewWord(false);
}

function setSlidersFromBand(){
  fromSlider.value = String(band.from);
  toSlider.value = String(band.to);
  syncBandUIFromSliders();
}

function syncBandUIFromSliders(){
  let f = parseInt(fromSlider.value, 10);
  let t = parseInt(toSlider.value, 10);
  if(isNaN(f)) f = 1;
  if(isNaN(t)) t = 1;
  if(f > t){ t = f; toSlider.value = String(t); }

  // fromVal / toVal are editable number inputs
  if(fromVal && fromVal.tagName === "INPUT") fromVal.value = String(f);
  else if(fromVal) fromVal.textContent = String(f);

  if(toVal && toVal.tagName === "INPUT") toVal.value = String(t);
  else if(toVal) toVal.textContent = String(t);

  rangeLabel.textContent = `${f}‚Äì${t}`;
}


(function wireBandNumberInputs(){
  if(!fromVal || !toVal) return;
  if(fromVal.tagName !== "INPUT" || toVal.tagName !== "INPUT") return;

  const clampInt = (v, min, max) => {
    let n = parseInt(v, 10);
    if(isNaN(n)) n = min;
    n = Math.max(min, Math.min(max, n));
    return n;
  };

  const applyFromInputs = () => {
    if(!WORDS.length) return;
    const min = 1;
    const max = WORDS.length;

    let f = clampInt(fromVal.value, min, max);
    let t = clampInt(toVal.value, min, max);
    if(f > t){ t = f; }

    fromSlider.value = String(f);
    toSlider.value = String(t);
    syncBandUIFromSliders();
    applyBandFromSliders();
  };

  [fromVal, toVal].forEach(el=>{
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        el.blur();
      }
    });
    el.addEventListener("change", applyFromInputs);
    el.addEventListener("blur", applyFromInputs);
  });
})(); 


function applyBandFromSliders(){
  if(!currentUser) return;
  let f = parseInt(fromSlider.value, 10);
  let t = parseInt(toSlider.value, 10);
  if(isNaN(f)) f = 1;
  if(isNaN(t)) t = 1;
  if(f > t) t = f;

  band = { from: f, to: t };
  saveBand(currentUser, band);

  rebuildDeck();
  updatePills();
  renderList();

  revealed = false;
  elMarkRow.style.display = "none";
  elPrimaryControls.style.display = "flex";
  elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
pickNewWord(false);
}

function clearFailsForUser(){
  if(!currentUser) return;
  hardSet = new Set();
  saveHardWords(currentUser, []);
  rebuildDeck();
  updatePills();
  renderList();
  setStatus("Cleared poops  list");
}

function buildUnlockedFromLevel(level){
  // level: 0..AWARDS.length  (0 = ninguno, 1 = bronze, 2 = silver, ...)
  const unlocked = {};
  for(let i=0; i<AWARDS.length; i++){
    unlocked[AWARDS[i].id] = (i < level);
  }
  return unlocked;
}

function clampNonNegInt(v){
  let n = parseInt(v, 10);
  if(isNaN(n)) n = 0;
  if(n < 0) n = 0;
  return n;
}

function adminAwardsWithPassword(){
  if(!currentUser) return;

  const pw = prompt("Admin password:");
  if(pw !== "papa"){
    setStatus("Wrong password");
    return;
  }

  const choice = prompt(
`ADMIN:
1 = Reset ALL to 0
2 = Set custom values
(Press Cancel to abort)`
  );
  if(choice === null) return;

  const c = String(choice).trim();

  if(c === "1"){
    // Full reset
    stats = { correct:0, wrong:0, streak:0, unlocked:{} };
    saveStats(currentUser, stats);

    // Also reset failed words (optional: keep as current behavior)
    hardSet.clear();
    saveHardWords(currentUser, []);

    lastCombo5At = 0;
    lastCombo10At = 0;
    lastCombo20At = 0;

    renderAwards();
    updatePills();
    setStatus("Admin: reset done");
    return;
  }

  if(c === "2"){
    // Set custom values
    const newCoins = clampNonNegInt(prompt("Set coins (correct answers):", String(stats.correct || 0)));
    const newPoops = clampNonNegInt(prompt("Set poops (wrong answers):", String(stats.wrong || 0)));

    // Premios: nivel 0..5 (seg√∫n AWARDS)
    const maxLevel = AWARDS.length;
    const levelDefault = (() => {
      // intenta inferir nivel actual desde stats.unlocked
      let lvl = 0;
      for(let i=0;i<AWARDS.length;i++){
        if(stats.unlocked && stats.unlocked[AWARDS[i].id]) lvl = i+1;
      }
      return lvl;
    })();

    let newLevel = prompt(
`Set awards level:
0 = none
1 = Bronze
2 = Silver
3 = Gold
4 = Trophy
5 = Crown
6 = Diamond Bee`,
String(levelDefault)
    );
    if(newLevel === null) return;
    newLevel = clampNonNegInt(newLevel);
    if(newLevel > maxLevel) newLevel = maxLevel;

    const clearFails = prompt("Clear poops  failed-words list too? (y/n)", "n");
    const doClearFails = (String(clearFails || "").trim().toLowerCase().startsWith("y"));

    stats.correct = newCoins;
    stats.wrong = newPoops;
    stats.streak = 0;            // por seguridad: evitar combos raros despu√©s de tocar stats
    stats.unlocked = buildUnlockedFromLevel(newLevel);

    saveStats(currentUser, stats);

    if(doClearFails){
      hardSet.clear();
      saveHardWords(currentUser, []);
    }

    lastCombo5At = 0;
    lastCombo10At = 0;
    lastCombo20At = 0;

    renderAwards();
    updatePills();
    setStatus(`Admin: set coins ${newCoins} poops ${newPoops} awards:${newLevel}/${maxLevel}`);
    return;
  }

  setStatus("Admin: cancelled");
}

function buildUnlockedFromLevel(level){
  // level: 0..AWARDS.length  (0 = ninguno, 1 = bronze, 2 = silver, ...)
  const unlocked = {};
  for(let i=0; i<AWARDS.length; i++){
    unlocked[AWARDS[i].id] = (i < level);
  }
  return unlocked;
}

function clampNonNegInt(v){
  let n = parseInt(v, 10);
  if(isNaN(n)) n = 0;
  if(n < 0) n = 0;
  return n;
}

function adminAwardsWithPassword(){
  if(!currentUser) return;

  const pw = prompt("Admin password:");
  if(pw !== "papa"){
    setStatus("Wrong password");
    return;
  }

  const choice = prompt(
`ADMIN:
1 = Reset ALL to 0
2 = Set custom values
(Press Cancel to abort)`
  );
  if(choice === null) return;

  const c = String(choice).trim();

  if(c === "1"){
    // Full reset
    stats = { correct:0, wrong:0, streak:0, unlocked:{} };
    saveStats(currentUser, stats);

    // Also reset failed words (optional: keep as current behavior)
    hardSet.clear();
    saveHardWords(currentUser, []);

    lastCombo5At = 0;
    lastCombo10At = 0;
    lastCombo20At = 0;

    renderAwards();
    updatePills();
    setStatus("Admin: reset done");
    return;
  }

  if(c === "2"){
    // Set custom values
    const newCoins = clampNonNegInt(prompt("Set coins (correct answers):", String(stats.correct || 0)));
    const newPoops = clampNonNegInt(prompt("Set poops (wrong answers):", String(stats.wrong || 0)));

    // Premios: nivel 0..5 (seg√∫n AWARDS)
    const maxLevel = AWARDS.length;
    const levelDefault = (() => {
      // intenta inferir nivel actual desde stats.unlocked
      let lvl = 0;
      for(let i=0;i<AWARDS.length;i++){
        if(stats.unlocked && stats.unlocked[AWARDS[i].id]) lvl = i+1;
      }
      return lvl;
    })();

    let newLevel = prompt(
`Set awards level:
0 = none
1 = Bronze
2 = Silver
3 = Gold
4 = Trophy
5 = Crown
6 = Diamond Bee`,
String(levelDefault)
    );
    if(newLevel === null) return;
    newLevel = clampNonNegInt(newLevel);
    if(newLevel > maxLevel) newLevel = maxLevel;

    const clearFails = prompt("Clear poops  failed-words list too? (y/n)", "n");
    const doClearFails = (String(clearFails || "").trim().toLowerCase().startsWith("y"));

    stats.correct = newCoins;
    stats.wrong = newPoops;
    stats.streak = 0;            // por seguridad: evitar combos raros despu√©s de tocar stats
    stats.unlocked = buildUnlockedFromLevel(newLevel);

    saveStats(currentUser, stats);

    if(doClearFails){
      hardSet.clear();
      saveHardWords(currentUser, []);
    }

    lastCombo5At = 0;
    lastCombo10At = 0;
    lastCombo20At = 0;

    renderAwards();
    updatePills();
    setStatus(`Admin: set coins ${newCoins} poops ${newPoops} awards:${newLevel}/${maxLevel}`);
    return;
  }

  setStatus("Admin: cancelled");
}


function setPracticeMode(mode){
  if(!currentUser) return;
  practiceMode = mode;
  savePracticeMode(currentUser, mode);
  syncModeUI();
  rebuildDeck();
  pickNewWord(false);
  renderList();
  updatePills();
  setStatus(mode === PRACTICE_MODES.FAILED ? "Failed-only mode" : "All-words mode");
}

function syncModeUI(){
  const isAll = practiceMode === PRACTICE_MODES.ALL;
  btnModeAll.classList.toggle("active", isAll);
  btnModeFailed.classList.toggle("active", !isAll);

  if(isAll){
    modeHint.textContent = "Practise all words (inside the band).";
  }else{
    modeHint.textContent = "Practise only poops  words (inside the band).";
  }
}

// NEW
function setOrderMode(mode){
  if(!currentUser) return;
  orderMode = mode;
  saveOrderMode(currentUser, mode);
  syncOrderUI();
  rebuildDeck();
  pickNewWord(false);
  renderList();
  updatePills();
  setStatus(mode === ORDER_MODES.ORDER ? "In-order mode" : "Random mode");
}

// NEW
function syncOrderUI(){
  const isRandom = orderMode === ORDER_MODES.RANDOM;
  btnOrderRandom.classList.toggle("active", isRandom);
  btnOrderInOrder.classList.toggle("active", !isRandom);

  if(isRandom){
    orderHint.textContent = "Random order (no repeats until all shown).";
  }else{
    orderHint.textContent = "In order (inside the band).";
  }
}

/* Deck builder:
   - practiceMode ALL vs FAILED filters the set
   - orderMode RANDOM uses weighted shuffle (failed words earlier)
   - orderMode ORDER uses natural index order */
function rebuildDeck(){
  if(!WORDS.length || !currentUser){ deck = []; return; }

  // Reset navigation history when the deck is rebuilt
  navBack = [];
  navForward = [];

  const lo = clampInt(band.from - 1, 0, WORDS.length - 1);
  const hi = clampInt(band.to - 1, lo, WORDS.length - 1);

  // Candidate indices in the band (optionally only failed)
  const candidates = [];
  for(let i=lo;i<=hi;i++){
    const word = WORDS[i];
    const isFailed = hardSet.has(word);
    if(practiceMode === PRACTICE_MODES.FAILED && !isFailed) continue;
    candidates.push(i);
  }

  // In-order mode: just walk the candidates
  if(orderMode === ORDER_MODES.ORDER){
    deck = candidates.slice();
    return;
  }

  // Random mode: weighted shuffle (no repeats)
  const items = [];
  for(const i of candidates){
    const word = WORDS[i];
    const isFailed = hardSet.has(word);

    let w = 1;
    if(isFailed) w += FAILED_BONUS_WEIGHT;

    const u = Math.random();
    const key = -Math.log(Math.max(1e-12, u)) / w;
    items.push({ i, key });
  }

  items.sort((a,b)=> a.key - b.key);
  deck = items.map(x => x.i);
}

function drawNextIndex(){
  if(deck.length === 0) rebuildDeck();
  if(deck.length === 0) return null;
  return deck.shift();
}

function pickNewWord(autoSpeak){
  if(!currentUser) return;
  closeHelpPanel();

  // If the user previously went back, allow moving forward through history first
  const hasForward = navForward.length > 0;
  const idx = hasForward ? navForward.pop() : drawNextIndex();

  if(!hasForward){
    // New word from the deck: forward history is no longer valid
    navForward = [];
  }

  if(idx === null){
    if(practiceMode === PRACTICE_MODES.FAILED){
      setStatus("No failed words in this band ‚úÖ");
    }else{
      setStatus("No words");
    }
    elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
    elMarkRow.style.display = "none";
    elPrimaryControls.style.display = "flex";
    return;
  }

  // Save where we came from (so Prev can return)
  if(currentIndex !== null && currentIndex !== idx){
    navBack.push(currentIndex);
  }

  currentIndex = idx;
  revealed = false;

  elMarkRow.style.display = "none";
  elPrimaryControls.style.display = "flex";
  elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
  updatePills();

  if(autoSpeak) speakCurrent();
}

function goPrev(autoSpeak){
  if(!currentUser) return;
  closeHelpPanel();
  if(navBack.length === 0){
    // Nothing to go back to
    return;
  }

  // Save current position so Next can move forward through history
  if(currentIndex !== null){
    navForward.push(currentIndex);
  }

  const idx = navBack.pop();
  currentIndex = idx;
  revealed = false;

  elMarkRow.style.display = "none";
  elPrimaryControls.style.display = "flex";
  elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
  updatePills();

  if(autoSpeak) speakCurrent();
}

function currentWord(){
  if(currentIndex === null) return "";
  return WORDS[currentIndex] || "";
}

// =================== MP3 timestamps (primary) + TTS fallback ===================
// Put these two files in: /audio/
//  - audio/bee_words.csv  (Index;Word;Start;End)  -> recommended: Bee_250_Words_only.csv renamed
//  - audio/bee_words.mp3  (the single MP3 with all words)
const MP3_PRIMARY_ENABLED = true;

// You can rename these as you like, just keep them in /audio/
const MP3_URLS = [
  // Prefer CBR (stable seeking), fallback to original
  "audio/bee_words_CBR.mp3",
  "audio/bee_words.mp3",

  // Absolute paths for web hosting
  "/audio/bee_words_CBR.mp3",
  "/audio/bee_words.mp3",

  // GitHub Pages subpath fallback
  "main/audio/bee_words_CBR.mp3",
  "main/audio/bee_words.mp3",
  "/main/audio/bee_words_CBR.mp3",
  "/main/audio/bee_words.mp3"
];

// Welcome intro MP3 (played when user selects their profile)
const INTRO_WELCOME_SRC = "audio/intro_spelling.mp3";
let introAudioEl = null;

function playWelcomeIntro(){
  try{
    if(!introAudioEl){
      introAudioEl = new Audio(INTRO_WELCOME_SRC);
      introAudioEl.preload = "auto";
    }
    // Restart from beginning each time
    introAudioEl.pause();
    introAudioEl.currentTime = 0;
    introAudioEl.play().catch(()=>{});
  }catch(e){}
}


function stopWelcomeIntro(){
  try{
    if(introAudioEl && !introAudioEl.paused){
      introAudioEl.pause();
      introAudioEl.currentTime = 0;
    }
  }catch(e){}
}


const CSV_URL = "audio/bee_words.csv";

// MP3 (single audio file) ‚Äî unified variables
let mp3Ctx = null;
let mp3Gain = null;
let mp3Buffer = null;      // decoded AudioBuffer used by mp3PlayByIndex
mp3Timestamps = null;  // array: mp3Timestamps[i] = {start,end,word}
let mp3Ready = false;
let mp3El = null;          
let mp3ResolvedUrl = null;  // chosen URL that works in this environment
let mp3Backend = null;      // "webaudio" | "htmlaudio"
let mp3HtmlStopTimer = null;
// <audio> used only to unlock iOS autoplay restrictions

function mp3ParseCSV(text){
  // Acepta cabecera EXACTA: Index,Word,Start,End
  // (tambi√©n tolera ';' como separador en el contenido)
  if(typeof text !== "string") throw new Error("CSV vac√≠o o no v√°lido");

  // Normaliza saltos
  const rawLines = text.replace(/\r/g, "").split("\n");

  // Quita l√≠neas vac√≠as iniciales
  const lines = rawLines.filter(l => l.trim().length > 0);
  if(lines.length === 0) throw new Error("CSV vac√≠o");

  // Detecta separador por la cabecera (prioriza coma)
  const headerLine = lines[0].trim();
  const headerNorm = headerLine.replace(/;/g, ",");
  if(headerNorm !== "Index,Word,Start,End"){
    throw new Error("Cabecera debe ser: Index,Word,Start,End");
  }

  // El separador real: si la cabecera contiene ';', usamos ';', si no ','
  const sep = headerLine.includes(";") ? ";" : ",";

  const out = [];
  for(let i=1;i<lines.length;i++){
    const line = lines[i];
    if(!line || !line.trim()) continue;

    // Split solo en separador (NO tocar espacios dentro de Word)
    const parts = line.split(sep);

    // Debe tener al menos 4 columnas
    if(parts.length < 4) continue;

    // OJO: Word puede contener separadores si el CSV estuviera mal; aqu√≠ asumimos formato est√°ndar:
    // Index | Word | Start | End
    // Mant√©n exactamente Word como viene (incluye espacios dobles si existieran)
    const idxStr   = (parts[0] ?? "").trim();
    const wordRaw  = (parts[1] ?? ""); // NO trim agresivo para preservar espacios internos
    const startStr = (parts[2] ?? "").trim();
    const endStr   = (parts[3] ?? "").trim();

    const idx = parseInt(idxStr, 10);
    const start = parseFloat(startStr);
    const end   = parseFloat(endStr);

    // Validaci√≥n m√≠nima
    if(!Number.isFinite(idx) || !Number.isFinite(start) || !Number.isFinite(end)) continue;
    if(end <= start) continue;

    out.push({
      index: idx,
      word: wordRaw,   // se conserva tal cual (incluye espacios internos)
      start: start,
      end: end
    });
  }

  // Ordena por index por si viene mezclado
  out.sort((a,b)=>a.index-b.index);

  return out;
}


function mp3LoadEmbeddedTimestamps(){
  try{
    const el = document.getElementById("TIMESTAMPS_CSV");
    if(!el) return null;
    const raw = (el.textContent || "").trim();
    if(!raw) return null;
    const rows = mp3ParseCSV(raw);
    if(!rows || !rows.length) return null;

    // Build 1-based array: mp3Timestamps[1]..[N]
    const maxIdx = rows[rows.length-1].index;
    const arr = new Array(maxIdx + 1);
    for(const r of rows){
      arr[r.index] = { start: r.start, end: r.end, word: r.word };
    }
    return arr;
  }catch(e){
    console.warn("Embedded timestamps parse failed:", e);
    return null;
  }
}

let mp3KickStarted = false;
function mp3Kickoff(){
  if(mp3KickStarted) return;
  mp3KickStarted = true;
  if(!MP3_PRIMARY_ENABLED) return;
  if(!mp3Timestamps) return;
  mp3EnsureReady().catch(()=>{});
}

async function mp3EnsureReady(){
  if (!MP3_PRIMARY_ENABLED) return false;
  if (mp3Ready) return true;

  // Helper: try URLs sequentially (for <audio> element)
  const tryAudioSrc = (el, urls) => new Promise(resolve => {
    let i = 0;
    const clean = () => {
      el.removeEventListener("canplaythrough", onOk);
      el.removeEventListener("loadedmetadata", onOk);
      el.removeEventListener("error", onErr);
    };
    const onOk = () => { clean(); resolve(urls[i-1] || null); };
    const onErr = () => { next(); };
    const next = () => {
      if (i >= urls.length){ clean(); resolve(null); return; }
      const u = urls[i++];
      try{
        el.src = u;
        el.load();
      }catch(e){
        next();
      }
    };
    el.addEventListener("canplaythrough", onOk, { once:false });
    el.addEventListener("loadedmetadata", onOk, { once:false });
    el.addEventListener("error", onErr, { once:false });
    next();
  });

  // Helper: try fetch+decode sequentially
  const tryFetchDecode = async (urls) => {
    for(const u of urls){
      try{
        const res = await fetch(u, { cache: "force-cache" });
        if(!res.ok) continue;
        const arr = await res.arrayBuffer();
        const decodedBuffer = await mp3Ctx.decodeAudioData(arr);
        if(decodedBuffer && decodedBuffer.duration > 0){
          mp3ResolvedUrl = u;
          mp3Buffer = decodedBuffer;
          return true;
        }
      }catch(e){
        // try next
      }
    }
    return false;
  };

  try{
    // 1) AudioContext
    if (!mp3Ctx){
      mp3Ctx = new (window.AudioContext || window.webkitAudioContext)();
      mp3Gain = mp3Ctx.createGain();
      mp3Gain.connect(mp3Ctx.destination);
    }

    // 2) Audio element (used for iOS unlock + HTMLAudio backend)
    if (!mp3El){
      const isFileProto = (location.protocol === "file:");
      mp3El = isFileProto ? new Audio() : document.createElement("audio");
      mp3El.preload = "auto";
      // Only set crossOrigin when we are NOT in file://
      if(!isFileProto) mp3El.crossOrigin = "anonymous";
      // If we created a detached <audio>, append so it can load reliably on some browsers
      if(!isFileProto){
        mp3El.muted = true;
        document.body.appendChild(mp3El);
      } else {
        mp3El.muted = false;
      }
    }

    const isFile = (location.protocol === "file:");
    const urls = (Array.isArray(MP3_URLS) && MP3_URLS.length) ? MP3_URLS : ["audio/bee_words.mp3"];

    // 3) Decide backend
    // - file:// blocks fetch() in most browsers (CORS), but <audio> usually works.
    // - http/https: prefer WebAudio (more precise + no drift), fallback to <audio>.
    if (isFile){
      // Local file:// mode: DO NOT use fetch/decode (CORS). Use HTMLAudio with RELATIVE paths.
      mp3Backend = "htmlaudio";
      mp3ResolvedUrl = null;

      // In file://, absolute "/audio/..." becomes "file:///C:/audio/..." and fails.
      const relUrls = urls.filter(u => typeof u === "string" && !u.startsWith("/"));
      const fileUrls = (relUrls.length ? relUrls : ["audio/bee_words.mp3"]);

      // Ensure a plain Audio element (new Audio) to mimic the working pattern from your flappy app
      if (!mp3El){
        mp3El = new Audio();
        mp3El.preload = "auto";
      }
      mp3El.muted = false;

      const chosen = await tryAudioSrc(mp3El, fileUrls);
      if(!chosen){
        mp3Ready = false;
        mp3Backend = null;
        mp3ResolvedUrl = null;
        return false;
      }
      mp3ResolvedUrl = chosen;
      mp3El.src = chosen;
      mp3Ready = true;
      return true;
    }

    // 4) WebAudio route (prefer)
    mp3Backend = "webaudio";

    // Make sure <audio> has a working src for iOS unlock as well
    const chosenForEl = await tryAudioSrc(mp3El, urls);
    if(chosenForEl){
      mp3ResolvedUrl = chosenForEl;
      mp3El.src = chosenForEl;
    }

    // iOS unlock (must be after a user gesture; if this runs without one it will just fail silently)
    try{
      await mp3El.play();
      mp3El.pause();
      mp3El.currentTime = 0;
    }catch(e){}

    // Fetch + decode (try all candidates)
    const ok = await tryFetchDecode(urls);
    if(ok){
      mp3Ready = true;
      return true;
    }

    // 5) Fallback to HTMLAudio even on web
    mp3Backend = "htmlaudio";
    if(!mp3ResolvedUrl){
      const chosen2 = await tryAudioSrc(mp3El, urls);
      mp3ResolvedUrl = chosen2;
    }
    if(!mp3ResolvedUrl) throw new Error("No MP3 URL worked");
    mp3El.src = mp3ResolvedUrl;
    mp3El.muted = false;
    mp3Ready = true;
    return true;

  } catch(err){
    console.error("MP3 init error:", err);
    mp3Ready = false;
    mp3Backend = null;
    mp3ResolvedUrl = null;
    return false;
  }
}



function mp3PlayByIndex(index){
  if (!mp3Ready) return false;
  if (!mp3Timestamps || !mp3Timestamps[index]) return false;

  const { start, end } = mp3Timestamps[index];
  const duration = Math.max(0, end - start);

  // Backend A: WebAudio (decoded buffer)
  if (mp3Backend === "webaudio"){
    if (!mp3Ctx || !mp3Gain || !mp3Buffer) return false;
    try{
      const src = mp3Ctx.createBufferSource();
      src.buffer = mp3Buffer;
      src.connect(mp3Gain);
      src.start(0, start, duration);
      return true;
    }catch(e){
      return false;
    }
  }

  // Backend B: HTMLAudio (works even on file:// without fetch)
  if (mp3Backend === "htmlaudio" && mp3El){
    try{
      if (mp3HtmlStopTimer){
        clearTimeout(mp3HtmlStopTimer);
        mp3HtmlStopTimer = null;
      }
      mp3El.pause();
      mp3El.currentTime = Math.max(0, start + 0.01); // tiny nudge avoids sticking
      mp3El.play().catch(()=>{});
      mp3HtmlStopTimer = setTimeout(()=>{
        try{ mp3El.pause(); }catch(e){}
      }, Math.max(20, duration * 1000 + 30));
      return true;
    }catch(e){
      return false;
    }
  }

  return false;
}



// Main entry: try MP3 timestamps first, else TTS
async function speakWordPrimary(wordText){
  const w = (wordText || "").trim();
  if(!w) return;

  // Find 1-based word index by list order
  const idx0 = WORDS.indexOf(w);
  const one = idx0 >= 0 ? (idx0 + 1) : null;

  // Try MP3 only if we can map to an index
  if(one !== null){
    try{
      const ok = await mp3EnsureReady();
      if(ok && mp3PlayByIndex(one)){
        return;
      }
    }catch(e){
      // fall through to TTS
    }
  }

  // Fallback: keep your existing voice system
  silentActivation();
  speakText(w);
}

// Prefer MP3 by 1-based word index (no string lookup). Falls back to TTS.
async function speakWordPrimaryByIndex(oneBasedIndex, wordText){
  const w = (wordText || "").trim();
  if(!w) return;
  if(oneBasedIndex == null) return speakWordPrimary(w);
  try{
    const ok = await mp3EnsureReady();
    if(ok && mp3PlayByIndex(oneBasedIndex)) return;
  }catch(e){}
  // fallback
  silentActivation();
  speakText(w);
}

function speakCurrent(){
  // If welcome intro is playing, stop it before playing the word
  stopWelcomeIntro();
  const w = currentWord();
  if(!w){ setStatus("No word"); return; }
  const one = (typeof currentIndex === "number" && currentIndex >= 0) ? (currentIndex + 1) : null;
  // MP3 timestamps primary, TTS fallback
  speakWordPrimaryByIndex(one, w);
}

let rewardCtx = null;

function playRewardCelebration(){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;

    if(!rewardCtx) rewardCtx = new AudioCtx();
    if(rewardCtx.state === "suspended") rewardCtx.resume().catch(()=>{});

    const now = rewardCtx.currentTime;

    /* üé∂ Victory jingle */
	const notes = [
	  { f: 880,  t: 0.00 },
	  { f: 1175, t: 0.20 },
	  { f: 1568, t: 0.42 },
	  { f: 1760, t: 0.64 } // (opcional) 4¬™ nota para m√°s ‚Äúfinal‚Äù
	];


    notes.forEach(n=>{
      const o = rewardCtx.createOscillator();
      const g = rewardCtx.createGain();

      o.type = "triangle";
      o.frequency.setValueAtTime(n.f, now + n.t);

      g.gain.setValueAtTime(0.0001, now + n.t);
      g.gain.exponentialRampToValueAtTime(0.25, now + n.t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now + n.t + 0.48);

      o.connect(g);
      g.connect(rewardCtx.destination);

      o.start(now + n.t);
      o.stop(now + n.t + 0.5);
    });

	/* üëè Synthetic applause */
	const applauseDur = 2.0; // <-- SUBE ESTO (1.6, 2.0, 2.5...)

	const noiseBuffer = rewardCtx.createBuffer(
	  1,
	  Math.floor(rewardCtx.sampleRate * applauseDur),
	  rewardCtx.sampleRate
	);

	const data = noiseBuffer.getChannelData(0);
	for(let i=0;i<data.length;i++){
	  // misma curva pero adaptada a la nueva duraci√≥n
	  data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / data.length, 2);
	}

	const noise = rewardCtx.createBufferSource();
	noise.buffer = noiseBuffer;

	const bp = rewardCtx.createBiquadFilter();
	bp.type = "bandpass";
	bp.frequency.value = 1400;
	bp.Q.value = 0.8;

	const ng = rewardCtx.createGain();
	ng.gain.setValueAtTime(0.0001, now + 0.05);
	ng.gain.exponentialRampToValueAtTime(0.18, now + 0.08);
	ng.gain.exponentialRampToValueAtTime(0.0001, now + 0.05 + applauseDur); // <-- antes 0.8

	noise.connect(bp);
	bp.connect(ng);
	ng.connect(rewardCtx.destination);

	noise.start(now + 0.05);
	noise.stop(now + 0.05 + applauseDur + 0.1); // <-- antes 0.9


  }catch(e){
    // sin audio, pero el confeti sigue
  }
}

/* Mario-style coin "ding" (synth) */
let coinCtx = null;

/* Session-only combo trackers (avoid re-triggering at the same milestone) */
lastCombo5At = 0;
lastCombo10At = 0;
lastCombo20At = 0;

function playCoin(){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;

    if(!coinCtx) coinCtx = new AudioCtx();
    if(coinCtx.state === "suspended") coinCtx.resume().catch(()=>{});

    const now = coinCtx.currentTime;

    // Tres notas ascendentes (m√°s "reward")
    const notes = [
      { f: 988,  t: 0.00 },  // B5
      { f: 1319, t: 0.07 },  // E6
      { f: 1760, t: 0.14 }   // A6
    ];

    notes.forEach(n => {
      const o = coinCtx.createOscillator();
      const g = coinCtx.createGain();
      const f = coinCtx.createBiquadFilter();

      o.type = "square"; // m√°s retro y brillante
      o.frequency.setValueAtTime(n.f, now + n.t);

      // Filtro para brillo (menos apagado)
      f.type = "lowpass";
      f.frequency.setValueAtTime(6500, now + n.t);

      // Envolvente m√°s larga y audible
      g.gain.setValueAtTime(0.0001, now + n.t);
      g.gain.exponentialRampToValueAtTime(0.15, now + n.t + 0.015);
      g.gain.exponentialRampToValueAtTime(0.0001, now + n.t + 0.25);

      o.connect(f);
      f.connect(g);
      g.connect(coinCtx.destination);

      o.start(now + n.t);
      o.stop(now + n.t + 0.28);
    });

  }catch(e){
    // si falla el audio, el juego sigue
  }
}



function getIconSizePx(el, fallback = 52){
  try{
    if(!el) return fallback;

    // Prefer the actual icon element (<img> or emoji <span>) inside the target
    let icon = null;
    if(el.querySelector){
      icon = el.querySelector("img") || el.querySelector(".emoji-pill") || el.querySelector(".emojiIcon") || el.querySelector(".statIcon");
    }
    const probe = icon || el;

    if(probe && probe.getBoundingClientRect){
      const r = probe.getBoundingClientRect();
      const w = Math.max(r.width || 0, r.height || 0);
      if(w > 0) return w;
    }

    // Fallback to computed width/font-size
    const cs = getComputedStyle(probe);
    const cw = parseFloat(cs.width);
    if(!isNaN(cw) && cw > 0) return cw;

    const fs = parseFloat(cs.fontSize);
    return isNaN(fs) ? fallback : fs;
  }catch{
    return fallback;
  }
}

function flyCoinXY(x0, y0, x1, y1, startSizePx = 48, endSizePx = (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pillIcon')) || 64)){
  try{
    const coin = document.createElement("div");
    coin.className = "coinFly";
    coin.innerHTML = iconCoinHTML("flyIconImg");

    // centrar el emoji (usa el tama√±o inicial)
    const half = startSizePx / 2;
    coin.style.left = (x0 - half) + "px";
    coin.style.top  = (y0 - half) + "px";
    coin.style.width = startSizePx + "px";
    coin.style.height = startSizePx + "px";
    coin.style.fontSize = startSizePx + "px";

    document.body.appendChild(coin);

    const dx = x1 - x0;
    const dy = y1 - y0;
    const lift = Math.min(190, Math.max(90, Math.hypot(dx, dy) * 0.35));
    const cx = x0 + dx * 0.5;
    const cy = Math.min(y0, y1) - lift;

    // escala final = tama√±o del icono destino / tama√±o inicial
    const endScale = Math.max(0.2, endSizePx / startSizePx);

    const anim = coin.animate([
      { transform: "translate(0,0) scale(1)", opacity: 1, offset: 0 },
      { transform: `translate(${(cx-x0)}px, ${(cy-y0)}px) scale(1.18)`, opacity: 1, offset: 0.55 },
      { transform: `translate(${(x1-x0)}px, ${(y1-y0)}px) scale(${endScale})`, opacity: 0.0, offset: 1 }
    ], {
      duration: 1400,
      easing: "cubic-bezier(.15,.9,.25,1)"
    });

    anim.onfinish = () => coin.remove();
  }catch(e){}
}


function flyCoinCombo(n, intervalMs){
  const fromEl = document.getElementById("wordBox") || document.getElementById("btnUp");
  const toPill = document.getElementById("goodPill");
  const toEl = toPill ? (toPill.querySelector("img") || toPill.querySelector(".emoji-pill") || toPill.querySelector(".emojiIcon") || toPill.querySelector(".statIcon") || toPill) : null;

  const count = Math.max(1, n|0);
  const step = Math.max(0, intervalMs|0);

  if(!fromEl || !toEl){
    for(let i=0;i<count;i++) setTimeout(()=>playCoin(), i*step);
    return;
  }

  const a = fromEl.getBoundingClientRect();
  const b = toEl.getBoundingClientRect();

  const vv = window.visualViewport;
  const ox = vv ? (vv.offsetLeft || 0) : 0;
  const oy = vv ? (vv.offsetTop  || 0) : 0;

  const x0 = a.left + a.width * 0.50 + ox;
  const y0 = a.top  + a.height * 0.35 + oy;

  const x1 = b.left + b.width  * 0.50 + ox;
  const y1 = b.top  + b.height * 0.50 + oy;

  const endSize = getIconSizePx(toPill || toEl, 52);

  for(let i=0;i<count;i++){
    setTimeout(()=>{
      playCoin();
      flyCoinXY(x0, y0, x1, y1, 48, endSize);
    }, i*step);
  }
}


function showComboBanner(type){
  const el = document.getElementById("comboBanner");
  if(!el) return;

  if(type === 5){
    el.innerHTML = `
      <div class="line1">Great job!</div>
      <div class="line2">5 in a row!</div>
      <div class="line3">+3 Coins Bonus</div>`;
  } else if(type === 10){
    el.innerHTML = `
      <div class="line1">Amazing! ‚≠ê</div>
      <div class="line2">10 in a row!</div>
      <div class="line3">+5 Coins Bonus</div>`;
  } else if(type === 20){
    el.innerHTML = `
      <div class="line1">Unstoppable! üöÄ</div>
      <div class="line2">20 in a row!</div>
      <div class="line3">+10 Coins Bonus</div>`;
  } else if(type === 40){
    el.innerHTML = `
      <div class="line1">LEGENDARY! ‚ú®</div>
      <div class="line2">40 in a row!</div>
      <div class="line3">+30 Coins Bonus</div>`;
  } else {
    return;
  }

  el.classList.remove("show");
  void el.offsetWidth;
  el.classList.add("show");
}


function flyPoop(fromEl, toEl){
  try{
    if(!fromEl || !toEl) return;

    const a = fromEl.getBoundingClientRect();

    // If a pill is passed, target its actual icon (img or emoji span) for positioning/sizing
    const dest = (toEl.querySelector ? (toEl.querySelector("img") || toEl.querySelector(".emoji-pill") || toEl.querySelector(".emojiIcon") || toEl.querySelector(".statIcon")) : null) || toEl;
    const b = dest.getBoundingClientRect();

    const vv = window.visualViewport;
    const ox = vv ? (vv.offsetLeft || 0) : 0;
    const oy = vv ? (vv.offsetTop  || 0) : 0;

    const x0 = a.left + a.width  * 0.50 + ox;
    const y0 = a.top  + a.height * 0.35 + oy;

    const x1 = b.left + b.width  * 0.50 + ox;
    const y1 = b.top  + b.height * 0.50 + oy;

    const startSize = 48;
    const endSize = getIconSizePx(dest, (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pillIcon')) || 64));
    const endScale = Math.max(0.2, endSize / startSize);

    const poop = document.createElement("div");
    poop.className = "poopFly";
    poop.innerHTML = iconPooHTML("flyIconImg");

    // exact center (we animate with translate(-50%,-50%))
    poop.style.left = x0 + "px";
    poop.style.top  = y0 + "px";
    poop.style.width  = startSize + "px";
    poop.style.height = startSize + "px";

    document.body.appendChild(poop);

    const dx = x1 - x0;
    const dy = y1 - y0;
    const lift = Math.min(160, Math.max(70, Math.hypot(dx, dy) * 0.28));
    const cx = x0 + dx * 0.5;
    const cy = Math.min(y0, y1) - lift;

    const anim = poop.animate([
      { transform: "translate(-50%,-50%) translate(0,0) scale(1)", opacity: 1, offset: 0 },
      { transform: `translate(-50%,-50%) translate(${(cx-x0)}px, ${(cy-y0)}px) scale(1.1) rotate(20deg)`, opacity: 1, offset: 0.55 },
      { transform: `translate(-50%,-50%) translate(${(x1-x0)}px, ${(y1-y0)}px) scale(${endScale}) rotate(0deg)`, opacity: 0.0, offset: 1 }
    ], {
      duration: 850,
      easing: "cubic-bezier(.25,.85,.3,1)"
    });

    anim.onfinish = () => poop.remove();
  }catch(e){}
}




function popGoodPill(){
  if(!elGoodPill) return;
  elGoodPill.classList.remove("pillPop");
  // Force reflow so animation retriggers
  void elGoodPill.offsetWidth;
  elGoodPill.classList.add("pillPop");
}


function popHardPill(){
  if(!elHardPill) return;
  elHardPill.classList.remove("pillPop");
  void elHardPill.offsetWidth;
  elHardPill.classList.add("pillPop");
}

/* Short defeat sound (synth) */
let failCtx = null;
function playFail(){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;

    if(!failCtx) failCtx = new AudioCtx();
    if(failCtx.state === "suspended") failCtx.resume().catch(()=>{});

    const now = failCtx.currentTime;

    // Main downward chirp
    const o = failCtx.createOscillator();
    const g = failCtx.createGain();
    const lp = failCtx.createBiquadFilter();

    o.type = "triangle";
    o.frequency.setValueAtTime(520, now);
    o.frequency.exponentialRampToValueAtTime(160, now + 0.18);

    lp.type = "lowpass";
    lp.frequency.setValueAtTime(1800, now);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.40, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);

    o.connect(lp);
    lp.connect(g);
    g.connect(failCtx.destination);

    o.start(now);
    o.stop(now + 0.24);

    // Small "thud" layer
    const o2 = failCtx.createOscillator();
    const g2 = failCtx.createGain();
    o2.type = "square";
    o2.frequency.setValueAtTime(110, now);
    g2.gain.setValueAtTime(0.0001, now);
    g2.gain.exponentialRampToValueAtTime(0.10, now + 0.008);
    g2.gain.exponentialRampToValueAtTime(0.0001, now + 0.08);
    o2.connect(g2);
    g2.connect(failCtx.destination);
    o2.start(now);
    o2.stop(now + 0.09);

  }catch(e){
    // ignore
  }
}



function speakText(text, onEnd){
  if(!text) return;
  if(!("speechSynthesis" in window)){
    alert("This browser does not support SpeechSynthesis.");
    return;
  }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = VOICE_LANG;
  if(preferredVoice) u.voice = preferredVoice;
  u.rate = 1.0;
  u.pitch = 1.02;
  u.onend = () => { if(onEnd) onEnd(); };
  u.onerror = () => { if(onEnd) onEnd(); };
  window.speechSynthesis.speak(u);
}

function openHelp(){
  openHelpPanel();
  const entry = HELP[currentWord()] || null;
  if(!entry){
    helpText.textContent = "No definition/example for this word.";
    speakText("Sorry. No definition or example is available for this word.");
    return;
  }
  helpText.textContent = "Choose: Definition or Example.";
  speakText("Would you like the definition or an example sentence?");
}

function openHelpPanel(){
  helpPanel.style.display = "flex";
}

function closeHelpPanel(){
  helpPanel.style.display = "none";
  helpText.textContent = "";
}

function speakHelp(kind){
  const w = currentWord();
  const entry = HELP[w] || null;
  if(!entry){
    helpText.textContent = "No definition/example for this word.";
    speakText("Sorry. No definition or example is available for this word.");
    return;
  }
  if(kind === "def"){
    if(!entry.def){
      helpText.textContent = "No definition available.";
      speakText("No definition available.");
      return;
    }
        helpText.textContent = "üîä Listening‚Ä¶";
    speakText("Definition. " + entry.def, () => { helpText.textContent = ""; });
  }else{
    if(!entry.ex){
      helpText.textContent = "No example available.";
      speakText("No example available.");
      return;
    }
        helpText.textContent = "üîä Listening‚Ä¶";
    speakText("Example sentence. " + entry.ex, () => { helpText.textContent = ""; });
  }
}

let revealTimer = null;
function revealWordLetterByLetter(){
  const w = currentWord();
  if(!w) return;

  revealed = true;
  elPrimaryControls.style.display = "none";
  elMarkRow.style.display = "flex";
  //elMarkRow.style.display = "none";

  if(revealTimer) clearInterval(revealTimer);

  elWordBox.textContent = "";
  setStatus("Showing‚Ä¶");

  const letters = [...w];
  let i = 0;

  revealTimer = setInterval(()=>{
    elWordBox.textContent += (letters[i] ?? "");
    i++;
    if(i >= letters.length){
      clearInterval(revealTimer);
      revealTimer = null;
      //setStatus("Mark it / poops ");
    }
  }, 140);
}



/* =========================
   Word disintegration (particles)
   ========================= */
const fxCanvas = document.getElementById("wordFx");
const fxCtx = fxCanvas ? fxCanvas.getContext("2d") : null;

function fxResize(){
  if(!fxCanvas || !fxCtx) return;
  // handle DPR for crisp particles
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  fxCanvas.width  = Math.floor(window.innerWidth  * dpr);
  fxCanvas.height = Math.floor(window.innerHeight * dpr);
  fxCanvas.style.width  = "100vw";
  fxCanvas.style.height = "100vh";
  fxCtx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize", fxResize, {passive:true});
fxResize();

function prefersReducedMotion(){
  return window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
}

function drawTextWithLetterSpacing(ctx, text, xCenter, yBaseline, font, letterSpacingPx){
  ctx.font = font;
  ctx.textBaseline = "alphabetic";
  ctx.textAlign = "left";
  const letters = Array.from(text);
  // measure per char to honor letter spacing approximately
  const widths = letters.map(ch => ctx.measureText(ch).width);
  const total = widths.reduce((a,b)=>a+b,0) + Math.max(0, letters.length-1) * letterSpacingPx;
  let x = xCenter - total/2;
  for(let i=0;i<letters.length;i++){
    ctx.fillText(letters[i], x, yBaseline);
    x += widths[i] + letterSpacingPx;
  }
}

function disintegrateWordParticles(el){
  if(!fxCanvas || !fxCtx || !el) return;
  if(prefersReducedMotion()){
    // small pop + fade only
    el.animate([{transform:"scale(1)", opacity:1},{transform:"scale(1.03)", opacity:1},{transform:"scale(0.98)", opacity:0.15}], {duration:260, easing:"ease-out"});
    return;
  }

  const text = (el.textContent || "").trim();
  if(!text || text === "‚Ä¢ ‚Ä¢ ‚Ä¢") return;

  const r = el.getBoundingClientRect();
  // Prepare offscreen canvas for sampling
  const off = document.createElement("canvas");
  const offCtx = off.getContext("2d");

  const pad = 12;
  const w = Math.ceil(r.width) + pad*2;
  const h = Math.ceil(r.height) + pad*2;
  off.width = w;
  off.height = h;

  const cs = getComputedStyle(el);
  const fontSize = parseFloat(cs.fontSize) || 48;
  const fontWeight = cs.fontWeight || "900";
  const fontFamily = cs.fontFamily || "system-ui";
  const letterSpacing = parseFloat(cs.letterSpacing) || 0;
  const font = `${fontWeight} ${fontSize}px ${fontFamily}`;

  offCtx.clearRect(0,0,w,h);
  offCtx.fillStyle = "#ffffff";
  offCtx.textBaseline = "alphabetic";

  // baseline: vertically center-ish
  const y = h/2 + fontSize*0.35;

  drawTextWithLetterSpacing(offCtx, text, w/2, y, font, letterSpacing);

  const img = offCtx.getImageData(0,0,w,h).data;

  // Build particles from sampled pixels
  const particles = [];
  const maxParticles = 450;
  const step = 3; // sampling stride in px
  for(let yy=0; yy<h; yy+=step){
    for(let xx=0; xx<w; xx+=step){
      const a = img[(yy*w + xx)*4 + 3];
      if(a > 80){
        particles.push({x: xx, y: yy});
      }
    }
  }
  if(!particles.length) return;

  // downsample if too many
  while(particles.length > maxParticles){
    particles.splice(Math.floor(Math.random()*particles.length), 1);
  }

  // Map particles to viewport coords
  const originX = r.left - pad;
  const originY = r.top  - pad;

  // show fx canvas
  fxCanvas.style.display = "block";

  // hide original word quickly
  el.style.visibility = "hidden";

  // animate particles
  const start = performance.now();
  const duration = 700;
  const drift = 0.18;   // subtle drift (stay near the word)
  const gravity = 0;      // no falling

  // precompute velocity (very subtle ‚Äî mostly fade in place)
  for(const p of particles){
    // tiny jitter so it feels like dust, but doesn't fly away
    p.vx = (Math.random()-0.5) * 0.18;
    p.vy = (Math.random()-0.5) * 0.18;
    p.life = Math.random()*0.25 + 0.75;
  }

  function frame(t){
    const dt = t - start;
    const k = Math.min(1, dt / duration);
    fxCtx.clearRect(0,0,window.innerWidth, window.innerHeight);

    // fade out
    //const alpha = Math.max(0, 1 - k * 1.6);
	const alpha = 1 - k;
    fxCtx.globalAlpha = alpha;
    fxCtx.fillStyle = getComputedStyle(el).color || "#ffd166";

    // particle size shrinks slightly
    const size = 2.2 - k*0.8;

    for(const p of particles){
      const px = originX + p.x + p.vx * dt * drift;
      const py = originY + p.y + (p.vy * dt * drift) + (dt*dt*gravity);
      fxCtx.fillRect(px, py, size, size);
    }

    fxCtx.globalAlpha = 1;

    if(dt < duration){
      requestAnimationFrame(frame);
    }else{
      fxCtx.clearRect(0,0,window.innerWidth, window.innerHeight);
      fxCanvas.style.display = "none";
      el.style.visibility = "visible";
    }
  }
  requestAnimationFrame(frame);
}



function playWrongWordFX(){
  const el = document.getElementById("wordBox");
  if(!el) return;
  // restart animation even if user fails twice quickly
  el.classList.remove("wrongFX");
  void el.offsetWidth;
  el.classList.add("wrongFX");
  setTimeout(()=>{ try{ el.classList.remove("wrongFX"); }catch(e){} }, 650);
}


function markWord(gotIt){
  if(!revealed) return;
  const w = currentWord();
  if(!w || !currentUser) return;

  if(gotIt){
    // Success feedback
    popGoodPill();
if(hardSet.has(w)){
      hardSet.delete(w);
      saveHardWords(currentUser, [...hardSet]);
    }
    //setStatus("Nice! ‚úÖ");
  } else {
    // Fail feedback
    playWrongWordFX();
    popHardPill();
    playFail();
    flyPoop((document.getElementById("wordBox")||document.getElementById("btnDown")), document.getElementById("hardPill"));

    hardSet.add(w);
    saveHardWords(currentUser, [...hardSet]);
    //setStatus("Saved to practise üìå");
  }

  // Stats + awards (per user)
  // Normalize stats fields (avoid NaN streak)
  stats.correct = Number(stats.correct) || 0;
  stats.wrong   = Number(stats.wrong) || 0;
  stats.streak  = Number(stats.streak) || 0;

  if(gotIt){
    stats.streak++;
// Coin rewards (exclusive tiers, never stack):
// - 40,80,120... => +30 coins  (BONUS 40)
// - 20,60,100... => +10 coins
// - 10,30,50...  => +5 coins
// - 5,15,25...   => +3 coins
// otherwise      => +1 coin
let awardCoins = 1;     // what we ADD to stats.correct
let visualCoins = 1;    // how many flying coins we show (capped for performance)
let intervalMs = 0;

// Highest priority first
if(stats.streak % 40 === 0 && stats.streak !== lastCombo40At){
  awardCoins = 30;
  visualCoins = Math.min(30, awardCoins);
  intervalMs = 130;
  lastCombo40At = stats.streak;
  showComboBanner(40);
} else if(stats.streak % 20 === 0 && stats.streak !== lastCombo20At){
  awardCoins = 10;
  visualCoins = awardCoins;
  intervalMs = 140;
  lastCombo20At = stats.streak;
  showComboBanner(20);
} else if(stats.streak % 10 === 0 && stats.streak !== lastCombo10At){
  awardCoins = 5;
  visualCoins = awardCoins;
  intervalMs = 160;
  lastCombo10At = stats.streak;
  showComboBanner(10);
} else if(stats.streak % 5 === 0 && stats.streak !== lastCombo5At){
  awardCoins = 3;
  visualCoins = awardCoins;
  intervalMs = 180;
  lastCombo5At = stats.streak;
  showComboBanner(5);
}

flyCoinCombo(visualCoins, intervalMs);

    // Word disintegration effect
    try{ disintegrateWordParticles(elWordBox); }catch(e){}

    // Add coins to the counter
    stats.correct += awardCoins;
}else{
    stats.wrong++;
    stats.streak = 0;
    lastCombo5At = 0;
    lastCombo10At = 0;
    lastCombo20At = 0;
    lastCombo40At = 0;
  }
  saveStats(currentUser, stats);
  renderAwards();
  checkAwardsAndCelebrate();

  updatePills();
  setStatus("Ready");

  setTimeout(()=>{
    revealed = false;
    elMarkRow.style.display = "none";
    elPrimaryControls.style.display = "flex";
    elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
    pickNewWord(false);
  }, 360);
}

function openMenu(){
  if(!currentUser){ openUserPicker(false); return; }
  backdrop.classList.add("open");
  syncModeUI();
  syncOrderUI();
  renderList();
}
function closeMenu(){ backdrop.classList.remove("open"); }

function renderList(){
  if(!currentUser || !WORDS.length){ elListBox.innerHTML = "<b>No words</b>"; return; }

  const q = (elSearch.value || "").trim().toLowerCase();
  const lo = clampInt(band.from - 1, 0, WORDS.length - 1);
  const hi = clampInt(band.to - 1, lo, WORDS.length - 1);

  let list = [];
  if(activeTab === "all"){
    for(let i=lo;i<=hi;i++){
      const ww = WORDS[i];
      list.push({ n: i+1, w: ww, failed: hardSet.has(ww) });
    }
  } else {
    for(let i=lo;i<=hi;i++){
      const ww = WORDS[i];
      if(hardSet.has(ww)) list.push({ n: i+1, w: ww, failed: true });
    }
  }

  if(q){
    list = list.filter(x => x.w.toLowerCase().includes(q) || String(x.n).includes(q));
  }

  const title = activeTab === "all"
    ? `All words in band (${hi-lo+1})`
    : `Failed in band (${list.length})`;

  if(list.length === 0){
    elListBox.innerHTML = `<b>${title}</b><br><br>` + (activeTab === "bad" ? "Empty ‚úÖ" : "No match.");
    return;
  }

  elListBox.innerHTML =
    `<b>${title}</b><br><br>` +
    list.map(x => `
      <div class="listItem" data-w="${encodeURIComponent(x.w)}" title="Tap to hear pronunciation">
        <div>${x.n}. ${escapeHtml(x.w)}</div>
        <div>${x.failed ? `<span class="tagBad"> <img src="img/poo.png" class="iconImg" alt="poo" onload="this.classList.add('loaded');this.style.opacity=1" onerror="iconFallback(this,'üí©')"> </span>` : `<span class="tagOk">‚úì</span>`}</div>
      </div>
    `).join("");
}

function updatePills(){
  if(!currentUser){
    elRangePill.textContent = `Range: ‚Äî`;
    elHardPill.innerHTML = `${iconPooHTML("statIconImg")}<div class="statNum">${hardSet ? hardSet.size : 0}</div>`;
    return;
  }
  elRangePill.textContent = `${band.from}‚Äì${band.to}`;

  const lo = clampInt(band.from - 1, 0, WORDS.length - 1);
  const hi = clampInt(band.to - 1, lo, WORDS.length - 1);
  let failedInBand = 0;
  for(let i=lo;i<=hi;i++) if(hardSet.has(WORDS[i])) failedInBand++;
  elHardPill.innerHTML = `${iconPooHTML("statIconImg")}<div class="statNum">${hardSet ? hardSet.size : 0}</div>`;
  rangeLabel.textContent = `${band.from}‚Äì${band.to}`;
  // correct counter
  if(elGoodPill){ elGoodPill.innerHTML = `${iconCoinHTML("statIconImg")}<div class="statNum">${(stats && stats.correct) ? stats.correct : 0}</div>`; }
}

/* Storage keys (per user) */
function keyHard(user){ return `spbee_${user}_failedWords`; }
function keyBand(user){ return `spbee_${user}_band`; }
function keyMode(user){ return `spbee_${user}_practiceMode`; }
// NEW
function keyOrder(user){ return `spbee_${user}_orderMode`; }

function loadHardWords(user){
  try{
    const raw = localStorage.getItem(keyHard(user));
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveHardWords(user, arr){
  try{ localStorage.setItem(keyHard(user), JSON.stringify(arr)); }catch{}
}

function loadBand(user){
  try{
    const raw = localStorage.getItem(keyBand(user));
    if(!raw) return { from: 1, to: Math.max(1, WORDS.length) };
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") throw new Error();
    const f = clampInt(obj.from ?? 1, 1, Math.max(1, WORDS.length));
    const t = clampInt(obj.to ?? Math.max(1, WORDS.length), f, Math.max(1, WORDS.length));
    return { from: f, to: t };
  }catch{
    return { from: 1, to: Math.max(1, WORDS.length) };
  }
}
function saveBand(user, bandObj){
  try{ localStorage.setItem(keyBand(user), JSON.stringify(bandObj)); }catch{}
}

function loadPracticeMode(user){
  try{
    const raw = localStorage.getItem(keyMode(user));
    if(raw === PRACTICE_MODES.FAILED) return PRACTICE_MODES.FAILED;
    return PRACTICE_MODES.ALL;
  }catch{
    return PRACTICE_MODES.ALL;
  }
}
function savePracticeMode(user, mode){
  try{ localStorage.setItem(keyMode(user), mode); }catch{}
}

// NEW
function loadOrderMode(user){
  try{
    const raw = localStorage.getItem(keyOrder(user));
    if(raw === ORDER_MODES.ORDER) return ORDER_MODES.ORDER;
    return ORDER_MODES.RANDOM;
  }catch{
    return ORDER_MODES.RANDOM;
  }
}
// NEW
function saveOrderMode(user, mode){
  try{ localStorage.setItem(keyOrder(user), mode); }catch{}
}

/* Utils */
function setStatus(){ /* status pill removed */ }
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}
function clampInt(v, min, max){
  v = parseInt(v, 10);
  if(isNaN(v)) v = min;
  return Math.max(min, Math.min(max, v));
}
</script>
</body>
</html>
