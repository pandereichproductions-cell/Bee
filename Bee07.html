<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPELLING Bee 25‚Äì26</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#eaf0ff;
      --muted:#b8c5ea;
      --good:#3ee08f;
      --bad:#ff6b6b;
      --accent:#ffd166;
    }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 20% 10%, #1a2a55 0%, var(--bg) 55%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:min(880px, 100%);
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      position:relative;
      height: calc(100vh - 36px);      /* 18px padding arriba + 18px abajo */
      max-height: 980px;              /* tope en desktop grande */
      display: flex;
      flex-direction: column;
    }
    header{
      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(0,0,0,.10);
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:10px;
    }
    header .left{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .titles{ display:flex; flex-direction:column; gap:2px; }
    header h1{ margin:0; font-size:17px; letter-spacing:.5px; }
    header .subtitle{ font-size:12px; color:var(--muted); letter-spacing:.2px; }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      color: var(--muted);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .menuBtn{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 12px;
      font-size:16px;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    main{
      flex: 1;
      overflow: auto;
      padding: 18px;
    }

    .bigWord{
      margin:10px 0 12px;
      min-height:92px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight:900;
      letter-spacing: 7px;
      font-size: clamp(38px, 7vw, 68px);
      color: var(--accent);
      text-shadow: 0 8px 30px rgba(0,0,0,.35);
      user-select:none;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      justify-content:center;
    }
    button{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:14px 16px;
      font-size:16px;
      cursor:pointer;
      user-select:none;
      transition: transform .04s ease, background .15s ease;
      min-width: 150px;
    }
    button:active{ transform: scale(.98); }
    button.primary{
      background: rgba(255, 209, 102, .18);
      border-color: rgba(255, 209, 102, .35);
    }
    button.next{ background: rgba(255,255,255,.10); }
    button.good{
      background: rgba(62, 224, 143, .16);
      border-color: rgba(62, 224, 143, .35);
      min-width: 160px;
    }
    button.bad{
      background: rgba(255, 107, 107, .16);
      border-color: rgba(255, 107, 107, .35);
      min-width: 160px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      font-size:13px;
      color: var(--muted);
      white-space:nowrap;
    }

    /* MENU DRAWER */
    .drawerBackdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 50;
    }
    .drawer{
      position:absolute;
      top:0; right:0;
      height:100%;
      width:min(420px, 90vw);
      background: rgba(17,27,46,.98);
      border-left:1px solid rgba(255,255,255,.10);
      transform: translateX(100%);
      transition: transform .18s ease;
      padding:12px;
      box-sizing:border-box;
      overflow:auto;
    }
    .drawerBackdrop.open{ display:block; }
    .drawerBackdrop.open .drawer{ transform: translateX(0%); }
    .drawer h2{ margin:0 0 10px; font-size:16px; }
    .drawer .small{ color: var(--muted); font-size:12px; margin:0 0 8px; }
    .drawer .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .drawer .btnRow button{ min-width: 0; flex:1; padding:12px 12px; font-size:14px; }

    .tabs{ display:flex; gap:8px; margin-top:12px; }
    .tabBtn{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      font-size:13px;
    }
    .tabBtn.active{
      border-color: rgba(255, 209, 102, .35);
      background: rgba(255, 209, 102, .14);
    }
    .search{
      width:100%;
      margin-top:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    .listBox{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      max-height: 260px;  /* menos alto => menos scroll general del drawer */
      overflow:auto;
      font-size:13px;
      color: var(--muted);
      line-height:1.55;
    }
    .listItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .listItem:last-child{ border-bottom:none; }
    .tagBad{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.12);
      color: var(--text);
    }
    .tagOk{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(62,224,143,.35);
      background: rgba(62,224,143,.12);
      color: var(--text);
    }

    /* Range selector */
    .rangeCard{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .rangeTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .rangeTop b{ color: var(--text); }
    .rangeRow{
      display:grid;
      grid-template-columns: 60px 1fr 60px;
      gap:10px;
      align-items:center;
      margin-top:8px;
    }
    input[type="range"]{ width:100%; accent-color: var(--accent); }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas;
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      text-align:center;
    }

    /* Practice mode toggle */
    .modeCard{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .seg{
      display:flex; gap:8px; margin-top:8px;
    }
    .seg button{
      flex:1;
      min-width:0;
      padding:10px 10px;
      font-size:13px;
      border-radius:14px;
    }
    .seg button.active{
      border-color: rgba(255, 209, 102, .35);
      background: rgba(255, 209, 102, .14);
    }

    /* User picker overlay */
    .overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 80;
      padding:18px;
    }
    .overlay.open{ display:flex; }
    .picker{
      width:min(520px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,27,46,.98);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding:16px;
    }
    .picker h2{ margin:0 0 6px; font-size:18px; }
    .picker p{ margin:0 0 12px; color: var(--muted); font-size:13px; }
    .pickerGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .userBtn{
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      text-align:center;
      transition: transform .04s ease;
    }
    .userBtn:active{ transform: scale(.98); }
    .avatar{ font-size:40px; margin-bottom:8px; }
    .initials{ font-weight:900; letter-spacing:.6px; font-size:18px; }
    .sub{ color: var(--muted); font-size:12px; margin-top:4px; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="left">
        <div class="titles">
          <h1>SPELLING Bee 25‚Äì26</h1>
          <div class="subtitle">5th and 6th graders</div>
        </div>
        <div class="badge" id="statusBadge">Choose user</div>
      </div>
      <button class="menuBtn" id="menuBtn" aria-label="Menu">‚ò∞ <span id="userBadge">‚Äî</span></button>
    </header>

    <main>
      <section class="card">
        <div class="row">
          <div class="pill" id="rangePill">Range: ‚Äî</div>
          <div class="pill" id="hardPill">üëé To practise: 0</div>
        </div>

        <div class="bigWord" id="wordBox">‚Ä¢ ‚Ä¢ ‚Ä¢</div>

        <div class="controls" id="primaryControls">
          <button class="primary" id="btnSpeak">üîä Listen</button>
          <button id="btnShow">üëÄ Show</button>
          <button class="next" id="btnNext">‚û°Ô∏è Next</button>
        </div>

        <div class="controls" id="markRow" style="display:none; margin-top:14px;">
          <button class="good" id="btnUp">üëç I got it</button>
          <button class="bad" id="btnDown">üëé Need practise</button>
        </div>
      </section>
    </main>

    <div class="drawerBackdrop" id="drawerBackdrop">
      <div class="drawer" role="dialog" aria-modal="true" aria-label="Menu">
        <h2>Menu</h2>
        <p class="small">One round = every word in the practice set exactly once (no repeats).</p>

        <div class="btnRow">
          <button id="btnSwitchUser">üë§ Switch user</button>
          <button id="btnCloseMenu">Close</button>
        </div>

        <!-- practice mode -->
        <div class="modeCard">
          <b>Practice mode</b>
          <div class="small" id="modeHint">‚Äî</div>
          <div class="seg">
            <button id="modeAll" class="active">All words</button>
            <button id="modeFailed">Failed only (üëé)</button>
          </div>
        </div>

        <!-- NEW: word order mode -->
        <div class="modeCard">
          <b>Word order</b>
          <div class="small" id="orderHint">‚Äî</div>
          <div class="seg">
            <button id="orderRandom" class="active">Random</button>
            <button id="orderInOrder">In order</button>
          </div>
        </div>

        <div class="rangeCard">
          <div class="rangeTop">
            <b>Practice band</b>
            <span class="mono" id="rangeLabel">‚Äî</span>
          </div>

          <div class="small">Choose word numbers (1 to <span id="maxN">0</span>)</div>

          <div class="rangeRow">
            <div class="mono" id="fromVal">1</div>
            <input type="range" id="fromSlider" min="1" max="1" value="1" />
            <div class="small" style="text-align:right;">From</div>
          </div>

          <div class="rangeRow">
            <div class="mono" id="toVal">1</div>
            <input type="range" id="toSlider" min="1" max="1" value="1" />
            <div class="small" style="text-align:right;">To</div>
          </div>

          <div class="btnRow" style="margin-top:10px;">
            <button id="btnApplyRange">Apply band</button>
            <button id="btnResetFails">Clear üëé list</button>
          </div>
        </div>

        <div class="tabs">
          <button class="tabBtn active" id="tabAll">All words (band)</button>
          <button class="tabBtn" id="tabBad">Failed (üëé) (band)</button>
        </div>

        <input class="search" id="searchBox" placeholder="Search‚Ä¶" />

        <div class="listBox" id="listBox"></div>

        <p class="small" style="margin-top:12px;">
          Voice: English (UK). Progress is saved separately for each user on this device.
        </p>
      </div>
    </div>

    <div class="overlay open" id="userOverlay">
      <div class="picker">
        <h2>Who are you?</h2>
        <p>Select your profile.</p>
        <div class="pickerGrid">
          <div class="userBtn" data-user="CHO">
            <div class="avatar">üë¶üèº</div>
            <div class="initials">CHO</div>
            <div class="sub">Boy</div>
          </div>
          <div class="userBtn" data-user="MHO">
            <div class="avatar">üëßüèΩ</div>
            <div class="initials">MHO</div>
            <div class="sub">Girl</div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/** Your exact list (kept in this exact order for band numbers) **/
const WORDS = [
  "abdomen","aboard","accident","anchor","ancient","Antarctica","anxious","appreciate","approximate","arrogant",
  "artificial","attempt","aware","assessment","associate","athlete","atmosphere","authority","awkward","beard",
  "beneficial","billboard","black","blend","blocks","bloom","bookstore","bracelet","breezy","brick",
  "bright","bubble","bungalow","bury","busy","captain","carpet","cashier","cell","cereal",
  "Chancellor","Chicago","chilly","circuit","circular","clerk","climate","comet","conservation","conquer",
  "corrosion","crater","credibility","crucial","crowd","curiosity","custom","decade","decide","design",
  "develop","dictation","dirty","disappearing","disguise","ecology","elderly","electricity","employer","end",
  "evaporate","event","expect","expensive","extremely","fascinate","fertilization","fiction","forbid","foreground",
  "foreign","forever","fragile","frustrate","galaxy","gas","generate","geranium","glove","goods",
  "glacier","grass","hesitate","hope","hostess","hotel","how","huge","idol","illness",
  "immense","impressionism","incredible","ingredients","inhale","inquiry","insomnia","integrity","jubilee","juvenile",
  "just","kindness","lamps","labyrinth","legendary","literacy","lifeguard","majestic","magma","male",
  "malice","marathon","marshmallow","master","metaphor","meridian","met","meteorology","melancholy","migration",
  "mitochondria","moisture","molars","monologue","moss","mosque","mount","muscle","narrow","nautical",
  "neurons","nerve","nickname","night","notorious","nutritious","obsession","offensive","operation","opponent",
  "orient","otherwise","outrageous","patience","paranormal","passionate","paycheck","peninsula","pharynx","philosopher",
  "phrase","pollen","pollination","post office","prejudice","preserve","program","prokaryotic","property","pry",
  "pyramid","quantity","raft","ranch","rare","read","receptor","reinforce","reindeer","relief",
  "renewable resources","repair","resort","reuse","ring","river","robbery","rush","sanctuary","skeptical",
  "sheet","shout","silkworms","silver","sled","snakebite","snowflake","soda","soil","solar",
  "solution","somehow","something","somewhere","speak","speed","spiral","spirit","spoil","spectacle",
  "squeeze","stage","stare","stem","stereo","stimulus","stove","stretch out","subject","suggested",
  "sunlight","suspect","tadpole","talkative","tendon","thunder","toboggan","tolerance","training","turbulence",
  "undertake","unpredictable","unicellular","virtual","vivid","viviparous","vow","wagged","war","wavy",
  "weapon","werewolf","which","wildlife","wind energy","womb","wonderful","wring","yearly","zygote"
];

const VOICE_LANG = "en-GB";
const FAILED_BONUS_WEIGHT = 4;

const USERS = {
  CHO: { label: "CHO", emoji: "üë¶üèº" },
  MHO: { label: "MHO", emoji: "üëßüèΩ" }
};

// practice mode (per user)
const PRACTICE_MODES = { ALL: "all", FAILED: "failed" };
let practiceMode = PRACTICE_MODES.ALL;

// NEW: word order mode (per user)
const ORDER_MODES = { RANDOM: "random", ORDER: "order" };
let orderMode = ORDER_MODES.RANDOM;

let currentUser = null;
let hardSet = new Set();
let band = { from: 1, to: 1 };
let currentIndex = null;
let revealed = false;

// deck: no repeats until all words in practice set are shown once
let deck = [];

const elStatus = document.getElementById("statusBadge");
const elUserBadge = document.getElementById("userBadge");
const elRangePill = document.getElementById("rangePill");
const elHardPill = document.getElementById("hardPill");
const elWordBox = document.getElementById("wordBox");

const elPrimaryControls = document.getElementById("primaryControls");
const elMarkRow = document.getElementById("markRow");

const backdrop = document.getElementById("drawerBackdrop");
const elListBox = document.getElementById("listBox");
const elSearch = document.getElementById("searchBox");
const tabAll = document.getElementById("tabAll");
const tabBad = document.getElementById("tabBad");
let activeTab = "all";

const userOverlay = document.getElementById("userOverlay");

const fromSlider = document.getElementById("fromSlider");
const toSlider   = document.getElementById("toSlider");
const fromVal = document.getElementById("fromVal");
const toVal = document.getElementById("toVal");
const rangeLabel = document.getElementById("rangeLabel");
const maxN = document.getElementById("maxN");

// practice mode buttons
const btnModeAll = document.getElementById("modeAll");
const btnModeFailed = document.getElementById("modeFailed");
const modeHint = document.getElementById("modeHint");

// NEW: order mode buttons
const btnOrderRandom = document.getElementById("orderRandom");
const btnOrderInOrder = document.getElementById("orderInOrder");
const orderHint = document.getElementById("orderHint");

/** Buttons **/
document.getElementById("btnSpeak").addEventListener("click", () => speakCurrent());
document.getElementById("btnShow").addEventListener("click", revealWordLetterByLetter);
document.getElementById("btnNext").addEventListener("click", () => pickNewWord(true));

document.getElementById("btnUp").addEventListener("click", () => markWord(true));
document.getElementById("btnDown").addEventListener("click", () => markWord(false));

document.getElementById("menuBtn").addEventListener("click", openMenu);
document.getElementById("btnCloseMenu").addEventListener("click", closeMenu);
document.getElementById("btnSwitchUser").addEventListener("click", () => { closeMenu(); openUserPicker(true); });
backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeMenu(); });

tabAll.addEventListener("click", ()=>{ activeTab="all"; tabAll.classList.add("active"); tabBad.classList.remove("active"); renderList(); });
tabBad.addEventListener("click", ()=>{ activeTab="bad"; tabBad.classList.add("active"); tabAll.classList.remove("active"); renderList(); });
elSearch.addEventListener("input", renderList);

document.getElementById("btnApplyRange").addEventListener("click", applyBandFromSliders);
document.getElementById("btnResetFails").addEventListener("click", clearFailsForUser);

fromSlider.addEventListener("input", syncBandUIFromSliders);
toSlider.addEventListener("input", syncBandUIFromSliders);

document.querySelectorAll(".userBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const u = btn.getAttribute("data-user");
    selectUser(u);
  });
});

// practice mode handlers
btnModeAll.addEventListener("click", ()=> setPracticeMode(PRACTICE_MODES.ALL));
btnModeFailed.addEventListener("click", ()=> setPracticeMode(PRACTICE_MODES.FAILED));

// NEW: order mode handlers
btnOrderRandom.addEventListener("click", ()=> setOrderMode(ORDER_MODES.RANDOM));
btnOrderInOrder.addEventListener("click", ()=> setOrderMode(ORDER_MODES.ORDER));

/** Init **/
init();

function init(){
  maxN.textContent = String(WORDS.length);
  fromSlider.max = String(Math.max(1, WORDS.length));
  toSlider.max = String(Math.max(1, WORDS.length));

  // Always ask user every open
  openUserPicker(false);
}

function openUserPicker(){
  userOverlay.classList.add("open");
  setStatus("Choose user");
}
function closeUserPicker(){ userOverlay.classList.remove("open"); }

function selectUser(userKey){
  if(!USERS[userKey]) return;
  currentUser = userKey;

  hardSet = new Set(loadHardWords(userKey));
  band = loadBand(userKey);
  practiceMode = loadPracticeMode(userKey);
  orderMode = loadOrderMode(userKey);

  band.from = clampInt(band.from, 1, Math.max(1, WORDS.length));
  band.to   = clampInt(band.to, band.from, Math.max(1, WORDS.length));

  elUserBadge.textContent = `${USERS[userKey].emoji} ${USERS[userKey].label}`;

  setSlidersFromBand();
  syncModeUI();
  syncOrderUI();
  updatePills();
  closeUserPicker();

  revealed = false;
  elMarkRow.style.display = "none";
  elPrimaryControls.style.display = "flex";
  elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
  setStatus("Ready");

  rebuildDeck();
  pickNewWord(false);
}

function setSlidersFromBand(){
  fromSlider.value = String(band.from);
  toSlider.value = String(band.to);
  syncBandUIFromSliders();
}

function syncBandUIFromSliders(){
  let f = parseInt(fromSlider.value, 10);
  let t = parseInt(toSlider.value, 10);
  if(isNaN(f)) f = 1;
  if(isNaN(t)) t = 1;
  if(f > t){ t = f; toSlider.value = String(t); }
  fromVal.textContent = String(f);
  toVal.textContent = String(t);
  rangeLabel.textContent = `${f}‚Äì${t}`;
}

function applyBandFromSliders(){
  if(!currentUser) return;
  let f = parseInt(fromSlider.value, 10);
  let t = parseInt(toSlider.value, 10);
  if(isNaN(f)) f = 1;
  if(isNaN(t)) t = 1;
  if(f > t) t = f;

  band = { from: f, to: t };
  saveBand(currentUser, band);

  rebuildDeck();
  updatePills();
  renderList();

  revealed = false;
  elMarkRow.style.display = "none";
  elPrimaryControls.style.display = "flex";
  elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
  setStatus("Band applied");
  pickNewWord(false);
}

function clearFailsForUser(){
  if(!currentUser) return;
  hardSet = new Set();
  saveHardWords(currentUser, []);
  rebuildDeck();
  updatePills();
  renderList();
  setStatus("Cleared üëé list");
}

function setPracticeMode(mode){
  if(!currentUser) return;
  practiceMode = mode;
  savePracticeMode(currentUser, mode);
  syncModeUI();
  rebuildDeck();
  pickNewWord(false);
  renderList();
  updatePills();
  setStatus(mode === PRACTICE_MODES.FAILED ? "Failed-only mode" : "All-words mode");
}

function syncModeUI(){
  const isAll = practiceMode === PRACTICE_MODES.ALL;
  btnModeAll.classList.toggle("active", isAll);
  btnModeFailed.classList.toggle("active", !isAll);

  if(isAll){
    modeHint.textContent = "Practise all words (inside the band).";
  }else{
    modeHint.textContent = "Practise only üëé words (inside the band).";
  }
}

// NEW
function setOrderMode(mode){
  if(!currentUser) return;
  orderMode = mode;
  saveOrderMode(currentUser, mode);
  syncOrderUI();
  rebuildDeck();
  pickNewWord(false);
  renderList();
  updatePills();
  setStatus(mode === ORDER_MODES.ORDER ? "In-order mode" : "Random mode");
}

// NEW
function syncOrderUI(){
  const isRandom = orderMode === ORDER_MODES.RANDOM;
  btnOrderRandom.classList.toggle("active", isRandom);
  btnOrderInOrder.classList.toggle("active", !isRandom);

  if(isRandom){
    orderHint.textContent = "Random order (no repeats until all shown).";
  }else{
    orderHint.textContent = "In order (inside the band).";
  }
}

/* Deck builder:
   - practiceMode ALL vs FAILED filters the set
   - orderMode RANDOM uses weighted shuffle (failed words earlier)
   - orderMode ORDER uses natural index order */
function rebuildDeck(){
  if(!WORDS.length || !currentUser){ deck = []; return; }

  const lo = clampInt(band.from - 1, 0, WORDS.length - 1);
  const hi = clampInt(band.to - 1, lo, WORDS.length - 1);

  // Candidate indices in the band (optionally only failed)
  const candidates = [];
  for(let i=lo;i<=hi;i++){
    const word = WORDS[i];
    const isFailed = hardSet.has(word);
    if(practiceMode === PRACTICE_MODES.FAILED && !isFailed) continue;
    candidates.push(i);
  }

  // In-order mode: just walk the candidates
  if(orderMode === ORDER_MODES.ORDER){
    deck = candidates.slice();
    return;
  }

  // Random mode: weighted shuffle (no repeats)
  const items = [];
  for(const i of candidates){
    const word = WORDS[i];
    const isFailed = hardSet.has(word);

    let w = 1;
    if(isFailed) w += FAILED_BONUS_WEIGHT;

    const u = Math.random();
    const key = -Math.log(Math.max(1e-12, u)) / w;
    items.push({ i, key });
  }

  items.sort((a,b)=> a.key - b.key);
  deck = items.map(x => x.i);
}

function drawNextIndex(){
  if(deck.length === 0) rebuildDeck();
  if(deck.length === 0) return null;
  return deck.shift();
}

function pickNewWord(autoSpeak){
  if(!currentUser) return;

  const idx = drawNextIndex();
  if(idx === null){
    if(practiceMode === PRACTICE_MODES.FAILED){
      setStatus("No failed words in this band ‚úÖ");
    }else{
      setStatus("No words");
    }
    elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
    elMarkRow.style.display = "none";
    elPrimaryControls.style.display = "flex";
    return;
  }

  currentIndex = idx;
  revealed = false;

  elMarkRow.style.display = "none";
  elPrimaryControls.style.display = "flex";
  elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
  updatePills();

  if(autoSpeak) speakCurrent();
}

function currentWord(){
  if(currentIndex === null) return "";
  return WORDS[currentIndex] || "";
}

function speakCurrent(){
  const w = currentWord();
  if(!w){ setStatus("No word"); return; }
  if(!("speechSynthesis" in window)){
    setStatus("No voice support");
    alert("This browser does not support SpeechSynthesis.");
    return;
  }
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(w);
  u.lang = VOICE_LANG;
  u.rate = 1.0;
  u.pitch = 1.05;

  u.onstart = () => setStatus("Playing‚Ä¶");
  u.onend = () => setStatus("Ready");
  u.onerror = () => setStatus("Could not play");

  window.speechSynthesis.speak(u);
}

let revealTimer = null;
function revealWordLetterByLetter(){
  const w = currentWord();
  if(!w) return;

  revealed = true;
  elPrimaryControls.style.display = "none";
  elMarkRow.style.display = "flex";

  if(revealTimer) clearInterval(revealTimer);

  elWordBox.textContent = "";
  setStatus("Showing‚Ä¶");

  const letters = [...w];
  let i = 0;

  revealTimer = setInterval(()=>{
    elWordBox.textContent += (letters[i] ?? "");
    i++;
    if(i >= letters.length){
      clearInterval(revealTimer);
      revealTimer = null;
      setStatus("Mark it üëç / üëé");
    }
  }, 140);
}

function markWord(gotIt){
  if(!revealed) return;
  const w = currentWord();
  if(!w || !currentUser) return;

  if(gotIt){
    if(hardSet.has(w)){
      hardSet.delete(w);
      saveHardWords(currentUser, [...hardSet]);
    }
    setStatus("Nice! ‚úÖ");
  } else {
    hardSet.add(w);
    saveHardWords(currentUser, [...hardSet]);
    setStatus("Saved to practise üìå");
  }

  updatePills();

  setTimeout(()=>{
    revealed = false;
    elMarkRow.style.display = "none";
    elPrimaryControls.style.display = "flex";
    elWordBox.textContent = "‚Ä¢ ‚Ä¢ ‚Ä¢";
    pickNewWord(false);
  }, 280);
}

function openMenu(){
  if(!currentUser){ openUserPicker(false); return; }
  backdrop.classList.add("open");
  syncModeUI();
  syncOrderUI();
  renderList();
}
function closeMenu(){ backdrop.classList.remove("open"); }

function renderList(){
  if(!currentUser || !WORDS.length){ elListBox.innerHTML = "<b>No words</b>"; return; }

  const q = (elSearch.value || "").trim().toLowerCase();
  const lo = clampInt(band.from - 1, 0, WORDS.length - 1);
  const hi = clampInt(band.to - 1, lo, WORDS.length - 1);

  let list = [];
  if(activeTab === "all"){
    for(let i=lo;i<=hi;i++){
      const ww = WORDS[i];
      list.push({ n: i+1, w: ww, failed: hardSet.has(ww) });
    }
  } else {
    for(let i=lo;i<=hi;i++){
      const ww = WORDS[i];
      if(hardSet.has(ww)) list.push({ n: i+1, w: ww, failed: true });
    }
  }

  if(q){
    list = list.filter(x => x.w.toLowerCase().includes(q) || String(x.n).includes(q));
  }

  const title = activeTab === "all"
    ? `All words in band (${hi-lo+1})`
    : `Failed (üëé) in band (${list.length})`;

  if(list.length === 0){
    elListBox.innerHTML = `<b>${title}</b><br><br>` + (activeTab === "bad" ? "Empty ‚úÖ" : "No match.");
    return;
  }

  elListBox.innerHTML =
    `<b>${title}</b><br><br>` +
    list.map(x => `
      <div class="listItem">
        <div>${x.n}. ${escapeHtml(x.w)}</div>
        <div>${x.failed ? `<span class="tagBad">üëé</span>` : `<span class="tagOk">‚úì</span>`}</div>
      </div>
    `).join("");
}

function updatePills(){
  if(!currentUser){
    elRangePill.textContent = `Range: ‚Äî`;
    elHardPill.textContent = `üëé To practise: 0`;
    return;
  }
  elRangePill.textContent = `Range: ${band.from}‚Äì${band.to}`;

  const lo = clampInt(band.from - 1, 0, WORDS.length - 1);
  const hi = clampInt(band.to - 1, lo, WORDS.length - 1);
  let failedInBand = 0;
  for(let i=lo;i<=hi;i++) if(hardSet.has(WORDS[i])) failedInBand++;
  elHardPill.textContent = `üëé To practise: ${failedInBand}`;
  rangeLabel.textContent = `${band.from}‚Äì${band.to}`;
}

/* Storage keys (per user) */
function keyHard(user){ return `spbee_${user}_failedWords`; }
function keyBand(user){ return `spbee_${user}_band`; }
function keyMode(user){ return `spbee_${user}_practiceMode`; }
// NEW
function keyOrder(user){ return `spbee_${user}_orderMode`; }

function loadHardWords(user){
  try{
    const raw = localStorage.getItem(keyHard(user));
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveHardWords(user, arr){
  try{ localStorage.setItem(keyHard(user), JSON.stringify(arr)); }catch{}
}

function loadBand(user){
  try{
    const raw = localStorage.getItem(keyBand(user));
    if(!raw) return { from: 1, to: Math.max(1, WORDS.length) };
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== "object") throw new Error();
    const f = clampInt(obj.from ?? 1, 1, Math.max(1, WORDS.length));
    const t = clampInt(obj.to ?? Math.max(1, WORDS.length), f, Math.max(1, WORDS.length));
    return { from: f, to: t };
  }catch{
    return { from: 1, to: Math.max(1, WORDS.length) };
  }
}
function saveBand(user, bandObj){
  try{ localStorage.setItem(keyBand(user), JSON.stringify(bandObj)); }catch{}
}

function loadPracticeMode(user){
  try{
    const raw = localStorage.getItem(keyMode(user));
    if(raw === PRACTICE_MODES.FAILED) return PRACTICE_MODES.FAILED;
    return PRACTICE_MODES.ALL;
  }catch{
    return PRACTICE_MODES.ALL;
  }
}
function savePracticeMode(user, mode){
  try{ localStorage.setItem(keyMode(user), mode); }catch{}
}

// NEW
function loadOrderMode(user){
  try{
    const raw = localStorage.getItem(keyOrder(user));
    if(raw === ORDER_MODES.ORDER) return ORDER_MODES.ORDER;
    return ORDER_MODES.RANDOM;
  }catch{
    return ORDER_MODES.RANDOM;
  }
}
// NEW
function saveOrderMode(user, mode){
  try{ localStorage.setItem(keyOrder(user), mode); }catch{}
}

/* Utils */
function setStatus(t){ elStatus.textContent = t; }
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[s]));
}
function clampInt(v, min, max){
  v = parseInt(v, 10);
  if(isNaN(v)) v = min;
  return Math.max(min, Math.min(max, v));
}
</script>
</body>
</html>
